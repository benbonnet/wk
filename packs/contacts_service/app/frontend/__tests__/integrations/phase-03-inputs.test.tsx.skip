import { describe, it, expect, vi } from "vitest";
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { UIProvider } from "@ui/lib/provider";
import { TooltipProvider } from "@ui-components/tooltip";
import {
  INPUT_TEXT,
  INPUT_TEXTAREA,
  INPUT_SELECT,
  INPUT_CHECKBOX,
  INPUT_CHECKBOXES,
  INPUT_RADIOS,
  INPUT_DATE,
  INPUT_TAGS,
} from "@ui/adapters/inputs";
import type { AdapterRegistry, UIServices } from "@ui/lib/registry";
import type { ReactNode } from "react";

const mockServices: UIServices = {
  fetch: vi.fn(),
  navigate: vi.fn(),
  toast: vi.fn(),
  confirm: vi.fn(),
};

const mockAdapters: AdapterRegistry = {
  INPUT_TEXT,
  INPUT_TEXTAREA,
  INPUT_SELECT,
  INPUT_CHECKBOX,
  INPUT_CHECKBOXES,
  INPUT_RADIOS,
  INPUT_DATE,
  INPUT_TAGS,
} as AdapterRegistry;

function TestWrapper({ children }: { children: ReactNode }) {
  return (
    <UIProvider
      adapters={mockAdapters}
      services={mockServices}
      locale="en"
    >
      <TooltipProvider>{children}</TooltipProvider>
    </UIProvider>
  );
}

describe("Phase 3: Input Adapters", () => {
  describe("3.1 Text Inputs", () => {
    describe("INPUT_TEXT", () => {
      it("renders with label", () => {
        render(
          <TestWrapper>
            <INPUT_TEXT name="email" label="Email Address" />
          </TestWrapper>
        );
        expect(screen.getByLabelText("Email Address")).toBeInTheDocument();
      });

      it("renders with placeholder", () => {
        render(
          <TestWrapper>
            <INPUT_TEXT name="email" placeholder="Enter your email" />
          </TestWrapper>
        );
        expect(screen.getByPlaceholderText("Enter your email")).toBeInTheDocument();
      });

      it("displays initial value", () => {
        render(
          <TestWrapper>
            <INPUT_TEXT name="email" label="Email" value="test@example.com" />
          </TestWrapper>
        );
        expect(screen.getByLabelText("Email")).toHaveValue("test@example.com");
      });

      it("calls onChange on user type", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_TEXT name="email" label="Email" onChange={handleChange} />
          </TestWrapper>
        );

        await user.type(screen.getByLabelText("Email"), "hello");
        // onChange called once per character typed
        expect(handleChange).toHaveBeenCalledTimes(5);
        // Each call receives the current input value (single char since uncontrolled)
        expect(handleChange).toHaveBeenNthCalledWith(1, "h");
        expect(handleChange).toHaveBeenNthCalledWith(2, "e");
      });
    });

    describe("INPUT_TEXTAREA", () => {
      it("renders multiline input", () => {
        render(
          <TestWrapper>
            <INPUT_TEXTAREA name="bio" label="Bio" />
          </TestWrapper>
        );
        expect(screen.getByLabelText("Bio").tagName).toBe("TEXTAREA");
      });

      it("respects rows prop", () => {
        render(
          <TestWrapper>
            <INPUT_TEXTAREA name="bio" label="Bio" rows={5} />
          </TestWrapper>
        );
        expect(screen.getByLabelText("Bio")).toHaveAttribute("rows", "5");
      });

      it("calls onChange on user type", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_TEXTAREA name="bio" label="Bio" onChange={handleChange} />
          </TestWrapper>
        );

        await user.type(screen.getByLabelText("Bio"), "Hello World");
        expect(handleChange).toHaveBeenCalled();
      });
    });
  });

  describe("3.2 Selection Inputs", () => {
    describe("INPUT_SELECT", () => {
      const options = [
        { label: "Option A", value: "a" },
        { label: "Option B", value: "b" },
        { label: "Option C", value: "c" },
      ];

      it("renders with label", () => {
        render(
          <TestWrapper>
            <INPUT_SELECT name="choice" label="Choice" options={options} />
          </TestWrapper>
        );
        expect(screen.getByText("Choice")).toBeInTheDocument();
      });

      it("renders with placeholder", () => {
        render(
          <TestWrapper>
            <INPUT_SELECT name="choice" placeholder="Select..." options={options} />
          </TestWrapper>
        );
        expect(screen.getByText("Select...")).toBeInTheDocument();
      });

      it("displays selected value label", () => {
        render(
          <TestWrapper>
            <INPUT_SELECT name="choice" value="b" options={options} />
          </TestWrapper>
        );
        expect(screen.getByText("Option B")).toBeInTheDocument();
      });

      it("calls onChange on selection", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_SELECT
              name="choice"
              label="Choice"
              options={options}
              onChange={handleChange}
            />
          </TestWrapper>
        );

        // Open the select
        await user.click(screen.getByRole("combobox"));
        // Select an option
        await user.click(screen.getByRole("option", { name: "Option A" }));

        expect(handleChange).toHaveBeenCalledWith("a");
      });
    });

    describe("INPUT_CHECKBOX", () => {
      it("renders checkbox", () => {
        render(
          <TestWrapper>
            <INPUT_CHECKBOX name="agree" label="I agree" />
          </TestWrapper>
        );
        expect(screen.getByRole("checkbox")).toBeInTheDocument();
        expect(screen.getByText("I agree")).toBeInTheDocument();
      });

      it("toggles on click", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_CHECKBOX name="agree" label="I agree" onChange={handleChange} />
          </TestWrapper>
        );

        await user.click(screen.getByRole("checkbox"));
        expect(handleChange).toHaveBeenCalledWith(true);
      });

      it("displays checked state", () => {
        render(
          <TestWrapper>
            <INPUT_CHECKBOX name="agree" label="I agree" value={true} />
          </TestWrapper>
        );
        expect(screen.getByRole("checkbox")).toBeChecked();
      });
    });

    describe("INPUT_CHECKBOXES", () => {
      const options = [
        { label: "Red", value: "red" },
        { label: "Blue", value: "blue" },
        { label: "Green", value: "green" },
      ];

      it("renders multiple checkboxes", () => {
        render(
          <TestWrapper>
            <INPUT_CHECKBOXES name="colors" label="Colors" options={options} />
          </TestWrapper>
        );
        expect(screen.getAllByRole("checkbox")).toHaveLength(3);
        expect(screen.getByText("Red")).toBeInTheDocument();
        expect(screen.getByText("Blue")).toBeInTheDocument();
        expect(screen.getByText("Green")).toBeInTheDocument();
      });

      it("displays checked state for selected values", () => {
        render(
          <TestWrapper>
            <INPUT_CHECKBOXES
              name="colors"
              options={options}
              value={["red", "green"]}
            />
          </TestWrapper>
        );
        const checkboxes = screen.getAllByRole("checkbox");
        expect(checkboxes[0]).toBeChecked(); // Red
        expect(checkboxes[1]).not.toBeChecked(); // Blue
        expect(checkboxes[2]).toBeChecked(); // Green
      });

      it("adds value to array on check", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_CHECKBOXES
              name="colors"
              options={options}
              value={["red"]}
              onChange={handleChange}
            />
          </TestWrapper>
        );

        await user.click(screen.getByLabelText("Blue"));
        expect(handleChange).toHaveBeenCalledWith(["red", "blue"]);
      });

      it("removes value from array on uncheck", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_CHECKBOXES
              name="colors"
              options={options}
              value={["red", "blue"]}
              onChange={handleChange}
            />
          </TestWrapper>
        );

        await user.click(screen.getByLabelText("Red"));
        expect(handleChange).toHaveBeenCalledWith(["blue"]);
      });
    });

    describe("INPUT_RADIOS", () => {
      const options = [
        { label: "Small", value: "s" },
        { label: "Medium", value: "m" },
        { label: "Large", value: "l" },
      ];

      it("renders radio group", () => {
        render(
          <TestWrapper>
            <INPUT_RADIOS name="size" label="Size" options={options} />
          </TestWrapper>
        );
        expect(screen.getAllByRole("radio")).toHaveLength(3);
      });

      it("allows single selection", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_RADIOS
              name="size"
              options={options}
              onChange={handleChange}
            />
          </TestWrapper>
        );

        await user.click(screen.getByLabelText("Medium"));
        expect(handleChange).toHaveBeenCalledWith("m");
      });

      it("displays selected state", () => {
        render(
          <TestWrapper>
            <INPUT_RADIOS name="size" options={options} value="l" />
          </TestWrapper>
        );
        expect(screen.getByLabelText("Large")).toBeChecked();
        expect(screen.getByLabelText("Small")).not.toBeChecked();
      });
    });
  });

  describe("3.3 Date Inputs", () => {
    describe("INPUT_DATE", () => {
      it("renders date picker trigger", () => {
        render(
          <TestWrapper>
            <INPUT_DATE name="dob" label="Date of Birth" />
          </TestWrapper>
        );
        expect(screen.getByRole("button")).toBeInTheDocument();
        expect(screen.getByText("Date of Birth")).toBeInTheDocument();
      });

      it("displays placeholder when no value", () => {
        render(
          <TestWrapper>
            <INPUT_DATE name="dob" placeholder="Select date" />
          </TestWrapper>
        );
        expect(screen.getByText("Select date")).toBeInTheDocument();
      });

      it("displays formatted date when value set", () => {
        render(
          <TestWrapper>
            <INPUT_DATE name="dob" value="2024-01-15" />
          </TestWrapper>
        );
        expect(screen.getByText("January 15th, 2024")).toBeInTheDocument();
      });

      it("opens calendar on click", async () => {
        const user = userEvent.setup();

        render(
          <TestWrapper>
            <INPUT_DATE name="dob" label="Date" />
          </TestWrapper>
        );

        await user.click(screen.getByRole("button"));
        // Calendar should be visible
        expect(screen.getByRole("grid")).toBeInTheDocument();
      });
    });
  });

  describe("3.4 Complex Inputs", () => {
    describe("INPUT_TAGS", () => {
      it("renders tag list", () => {
        render(
          <TestWrapper>
            <INPUT_TAGS name="tags" label="Tags" value={["react", "typescript"]} />
          </TestWrapper>
        );
        expect(screen.getByText("react")).toBeInTheDocument();
        expect(screen.getByText("typescript")).toBeInTheDocument();
      });

      it("adds tag on enter", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_TAGS name="tags" value={[]} onChange={handleChange} />
          </TestWrapper>
        );

        const input = screen.getByRole("textbox");
        await user.type(input, "newtag{Enter}");
        expect(handleChange).toHaveBeenCalledWith(["newtag"]);
      });

      it("removes tag on delete click", async () => {
        const user = userEvent.setup();
        const handleChange = vi.fn();

        render(
          <TestWrapper>
            <INPUT_TAGS
              name="tags"
              value={["react", "typescript"]}
              onChange={handleChange}
            />
          </TestWrapper>
        );

        // Find the X button inside the "react" badge
        const reactBadge = screen.getByText("react").closest("div");
        const removeButton = reactBadge?.querySelector("button");
        await user.click(removeButton!);

        expect(handleChange).toHaveBeenCalledWith(["typescript"]);
      });

      it("shows placeholder when empty", () => {
        render(
          <TestWrapper>
            <INPUT_TAGS name="tags" value={[]} placeholder="Add tags here" />
          </TestWrapper>
        );
        expect(screen.getByPlaceholderText("Add tags here")).toBeInTheDocument();
      });
    });
  });

  describe("3.5 Input States", () => {
    it("renders disabled state", () => {
      render(
        <TestWrapper>
          <INPUT_TEXT name="email" label="Email" disabled />
        </TestWrapper>
      );
      expect(screen.getByLabelText("Email")).toBeDisabled();
    });

    it("renders error message when provided", () => {
      render(
        <TestWrapper>
          <INPUT_TEXT name="email" label="Email" error="Email is required" />
        </TestWrapper>
      );
      expect(screen.getByText("Email is required")).toBeInTheDocument();
    });

    it("renders helper text", () => {
      render(
        <TestWrapper>
          <INPUT_TEXT name="email" label="Email" helperText="We'll never share your email" />
        </TestWrapper>
      );
      expect(screen.getByText("We'll never share your email")).toBeInTheDocument();
    });

    it("hides helper text when error is shown", () => {
      render(
        <TestWrapper>
          <INPUT_TEXT
            name="email"
            label="Email"
            helperText="Helper text"
            error="Error message"
          />
        </TestWrapper>
      );
      expect(screen.queryByText("Helper text")).not.toBeInTheDocument();
      expect(screen.getByText("Error message")).toBeInTheDocument();
    });

    it("SELECT renders disabled state", () => {
      render(
        <TestWrapper>
          <INPUT_SELECT
            name="choice"
            label="Choice"
            options={[{ label: "A", value: "a" }]}
            disabled
          />
        </TestWrapper>
      );
      expect(screen.getByRole("combobox")).toBeDisabled();
    });

    it("CHECKBOX renders disabled state", () => {
      render(
        <TestWrapper>
          <INPUT_CHECKBOX name="agree" label="Agree" disabled />
        </TestWrapper>
      );
      expect(screen.getByRole("checkbox")).toBeDisabled();
    });
  });
});

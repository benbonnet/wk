import { describe, it, expect, vi } from "vitest";
import { render, screen } from "@testing-library/react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { UIProvider } from "@ui/lib/provider";
import { TooltipProvider } from "@ui-components/tooltip";
import {
  GROUP,
  CARD_GROUP,
  ALERT,
  ACTIONS,
  SHOW,
  ShowContext,
} from "@ui/adapters/layouts";
import { DISPLAY_TEXT } from "@ui/adapters/displays";
import type { AdapterRegistry, UIServices } from "@ui/lib/registry";
import type { ReactNode } from "react";

const mockServices: UIServices = {
  fetch: vi.fn(),
  navigate: vi.fn(),
  toast: vi.fn(),
  confirm: vi.fn(),
};

const mockAdapters: AdapterRegistry = {
  GROUP,
  CARD_GROUP,
  ALERT,
  ACTIONS,
  SHOW,
  DISPLAY_TEXT,
} as AdapterRegistry;

function TestWrapper({ children }: { children: ReactNode }) {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });

  return (
    <QueryClientProvider client={queryClient}>
      <UIProvider
        adapters={mockAdapters}
        services={mockServices}
        locale="en"
      >
        <TooltipProvider>{children}</TooltipProvider>
      </UIProvider>
    </QueryClientProvider>
  );
}

describe("Phase 5: Layout Adapters", () => {
  describe("5.1 Basic Layouts", () => {
    describe("GROUP", () => {
      it("renders children", () => {
        render(
          <TestWrapper>
            <GROUP schema={{ type: "GROUP" }}>
              <div data-testid="child-1">Child 1</div>
              <div data-testid="child-2">Child 2</div>
            </GROUP>
          </TestWrapper>
        );
        expect(screen.getByTestId("child-1")).toBeInTheDocument();
        expect(screen.getByTestId("child-2")).toBeInTheDocument();
      });

      it("renders label as heading", () => {
        render(
          <TestWrapper>
            <GROUP schema={{ type: "GROUP", label: "Personal Information" }}>
              <div>Content</div>
            </GROUP>
          </TestWrapper>
        );
        expect(screen.getByText("Personal Information")).toBeInTheDocument();
        expect(screen.getByRole("heading", { level: 3 })).toHaveTextContent(
          "Personal Information"
        );
      });

      it("renders subtitle when provided", () => {
        render(
          <TestWrapper>
            <GROUP
              schema={{
                type: "GROUP",
                label: "Settings",
                subtitle: "Configure your preferences",
              }}
            >
              <div>Content</div>
            </GROUP>
          </TestWrapper>
        );
        expect(screen.getByText("Settings")).toBeInTheDocument();
        expect(screen.getByText("Configure your preferences")).toBeInTheDocument();
      });

      it("renders without header when no label", () => {
        render(
          <TestWrapper>
            <GROUP schema={{ type: "GROUP" }}>
              <div>Content</div>
            </GROUP>
          </TestWrapper>
        );
        expect(screen.queryByRole("heading")).not.toBeInTheDocument();
        expect(screen.getByText("Content")).toBeInTheDocument();
      });

      it("supports horizontal direction", () => {
        render(
          <TestWrapper>
            <GROUP schema={{ type: "GROUP", direction: "HORIZONTAL" }}>
              <div>Item 1</div>
              <div>Item 2</div>
            </GROUP>
          </TestWrapper>
        );
        // Content wrapper should have flex class
        const group = screen.getByText("Item 1").parentElement;
        expect(group).toHaveClass("flex");
      });
    });

    describe("CARD_GROUP", () => {
      it("renders children in card", () => {
        render(
          <TestWrapper>
            <CARD_GROUP schema={{ type: "CARD_GROUP" }}>
              <div data-testid="card-content">Card Content</div>
            </CARD_GROUP>
          </TestWrapper>
        );
        expect(screen.getByTestId("card-content")).toBeInTheDocument();
      });

      it("renders card title", () => {
        render(
          <TestWrapper>
            <CARD_GROUP schema={{ type: "CARD_GROUP", label: "Account Details" }}>
              <div>Content</div>
            </CARD_GROUP>
          </TestWrapper>
        );
        expect(screen.getByText("Account Details")).toBeInTheDocument();
      });

      it("renders card description", () => {
        render(
          <TestWrapper>
            <CARD_GROUP
              schema={{
                type: "CARD_GROUP",
                label: "Account",
                subtitle: "Manage your account settings",
              }}
            >
              <div>Content</div>
            </CARD_GROUP>
          </TestWrapper>
        );
        expect(screen.getByText("Account")).toBeInTheDocument();
        expect(screen.getByText("Manage your account settings")).toBeInTheDocument();
      });

      it("renders without header when no label", () => {
        render(
          <TestWrapper>
            <CARD_GROUP schema={{ type: "CARD_GROUP" }}>
              <div>Content</div>
            </CARD_GROUP>
          </TestWrapper>
        );
        expect(screen.queryByText("Account")).not.toBeInTheDocument();
        expect(screen.getByText("Content")).toBeInTheDocument();
      });
    });

    describe("ALERT", () => {
      it("renders message", () => {
        render(
          <TestWrapper>
            <ALERT schema={{ type: "ALERT", label: "This is important" }} />
          </TestWrapper>
        );
        expect(screen.getByText("This is important")).toBeInTheDocument();
      });

      it("renders with default color variant", () => {
        render(
          <TestWrapper>
            <ALERT schema={{ type: "ALERT", label: "Info message" }} />
          </TestWrapper>
        );
        expect(screen.getByRole("alert")).toBeInTheDocument();
      });

      it("renders with red color variant", () => {
        render(
          <TestWrapper>
            <ALERT schema={{ type: "ALERT", label: "Error!" }} color="red" />
          </TestWrapper>
        );
        const alert = screen.getByRole("alert");
        expect(alert).toHaveClass("text-red-600");
      });

      it("renders with green color variant", () => {
        render(
          <TestWrapper>
            <ALERT schema={{ type: "ALERT", label: "Success!" }} color="green" />
          </TestWrapper>
        );
        const alert = screen.getByRole("alert");
        expect(alert).toHaveClass("text-green-600");
      });

      it("renders with yellow color variant", () => {
        render(
          <TestWrapper>
            <ALERT schema={{ type: "ALERT", label: "Warning!" }} color="yellow" />
          </TestWrapper>
        );
        const alert = screen.getByRole("alert");
        expect(alert).toHaveClass("text-yellow-600");
      });

      it("renders subtitle when provided", () => {
        render(
          <TestWrapper>
            <ALERT
              schema={{
                type: "ALERT",
                label: "Heads up!",
                subtitle: "This action cannot be undone.",
              }}
            />
          </TestWrapper>
        );
        expect(screen.getByText("Heads up!")).toBeInTheDocument();
        expect(screen.getByText("This action cannot be undone.")).toBeInTheDocument();
      });
    });
  });

  describe("5.2 Show Layout", () => {
    it("renders children with data context", () => {
      render(
        <TestWrapper>
          <SHOW schema={{ type: "SHOW" }} record={{ name: "John" }}>
            <DISPLAY_TEXT name="name" label="Name" />
          </SHOW>
        </TestWrapper>
      );
      expect(screen.getByText("John")).toBeInTheDocument();
    });

    it("provides record data to child displays", () => {
      const record = {
        firstName: "Jane",
        lastName: "Doe",
        email: "jane@example.com",
      };

      render(
        <TestWrapper>
          <SHOW schema={{ type: "SHOW" }} record={record}>
            <DISPLAY_TEXT name="firstName" label="First Name" />
            <DISPLAY_TEXT name="lastName" label="Last Name" />
            <DISPLAY_TEXT name="email" label="Email" />
          </SHOW>
        </TestWrapper>
      );

      expect(screen.getByText("Jane")).toBeInTheDocument();
      expect(screen.getByText("Doe")).toBeInTheDocument();
      expect(screen.getByText("jane@example.com")).toBeInTheDocument();
    });

    it("renders title when provided", () => {
      render(
        <TestWrapper>
          <SHOW
            schema={{ type: "SHOW", title: "Contact Details" }}
            record={{ name: "John" }}
          >
            <DISPLAY_TEXT name="name" />
          </SHOW>
        </TestWrapper>
      );
      expect(screen.getByText("Contact Details")).toBeInTheDocument();
    });

    it("renders without title when not provided", () => {
      render(
        <TestWrapper>
          <SHOW schema={{ type: "SHOW" }} record={{ name: "John" }}>
            <DISPLAY_TEXT name="name" />
          </SHOW>
        </TestWrapper>
      );
      expect(screen.queryByText("Contact Details")).not.toBeInTheDocument();
      expect(screen.getByText("John")).toBeInTheDocument();
    });

    it("handles empty record", () => {
      render(
        <TestWrapper>
          <SHOW schema={{ type: "SHOW" }} record={{}}>
            <DISPLAY_TEXT name="name" label="Name" />
          </SHOW>
        </TestWrapper>
      );
      // Should show empty state
      expect(screen.getByText("â€”")).toBeInTheDocument();
    });
  });

  describe("5.3 Actions Layout", () => {
    it("renders children inline", () => {
      render(
        <TestWrapper>
          <ACTIONS schema={{ type: "ACTIONS" }}>
            <button>Action 1</button>
            <button>Action 2</button>
          </ACTIONS>
        </TestWrapper>
      );
      expect(screen.getByRole("button", { name: "Action 1" })).toBeInTheDocument();
      expect(screen.getByRole("button", { name: "Action 2" })).toBeInTheDocument();
    });

    it("applies flex gap styling", () => {
      render(
        <TestWrapper>
          <ACTIONS schema={{ type: "ACTIONS" }}>
            <button>Action 1</button>
            <button>Action 2</button>
          </ACTIONS>
        </TestWrapper>
      );
      const container = screen.getByRole("button", { name: "Action 1" }).parentElement;
      expect(container).toHaveClass("flex");
      expect(container).toHaveClass("gap-2");
    });

    it("applies custom className from schema", () => {
      render(
        <TestWrapper>
          <ACTIONS schema={{ type: "ACTIONS", className: "justify-end" }}>
            <button>Action</button>
          </ACTIONS>
        </TestWrapper>
      );
      const container = screen.getByRole("button").parentElement;
      expect(container).toHaveClass("justify-end");
    });
  });
});

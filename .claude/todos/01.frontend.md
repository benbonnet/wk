# Frontend Setup: Vite + React + Tailwind v4 + shadcn + Typelizer

Reference project: `../history/rbrun`

> **Dependency:** Complete `02.auth.md` after this for authentication setup.

---

## Phase 1: Package Installation

### 1.1 Update package.json

```bash
npm install react react-dom react-router @tanstack/react-query axios
npm install tailwindcss @tailwindcss/vite tw-animate-css
npm install class-variance-authority clsx tailwind-merge lucide-react
npm install @radix-ui/react-slot

npm install -D typescript @types/react @types/react-dom
npm install -D vite vite-plugin-ruby @vitejs/plugin-react
npm install -D vitest jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event
npm install -D eslint @eslint/js globals typescript-eslint eslint-plugin-react-hooks eslint-plugin-react-refresh
```

### 1.2 Update Gemfile (already has vite_rails, typelizer)

Ensure these are present:

```ruby
gem "vite_rails", "~> 3.0"
gem "typelizer", "~> 0.5.3"
gem "alba", "~> 3.10"
```

Run: `bundle install`

---

## Phase 2: Vite Configuration

### 2.1 Create `config/vite.json`

```json
{
  "all": {
    "sourceCodeDir": "app/frontend",
    "watchAdditionalPaths": []
  },
  "development": {
    "autoBuild": true,
    "publicOutputDir": "vite-dev",
    "port": 3040
  },
  "test": {
    "autoBuild": true,
    "publicOutputDir": "vite-test",
    "port": 3041
  }
}
```

### 2.2 Update `vite.config.ts`

```typescript
import { defineConfig } from "vite";
import RubyPlugin from "vite-plugin-ruby";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";
import path from "node:path";

export default defineConfig({
  plugins: [react(), tailwindcss(), RubyPlugin()],
  resolve: {
    alias: {
      "@/": `${path.resolve(__dirname, "./app/frontend/")}`,
    },
  },
});
```

### 2.3 Create `vitest.config.ts`

```typescript
import { defineConfig } from "vitest/config";
import react from "@vitejs/plugin-react";
import { resolve } from "path";

export default defineConfig({
  plugins: [react()],
  test: {
    environment: "jsdom",
    setupFiles: ["./vitest.setup.ts"],
    globals: true,
  },
  resolve: {
    alias: {
      "@": resolve(__dirname, "./app/frontend"),
    },
  },
});
```

### 2.4 Create `vitest.setup.ts`

```typescript
import "@testing-library/jest-dom";

global.fetch = vi.fn();
```

---

## Phase 3: TypeScript Configuration

### 3.1 Update `tsconfig.json`

```json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ],
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./app/frontend/*"]
    }
  }
}
```

### 3.2 Create `tsconfig.app.json`

```json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["app/frontend"]
}
```

### 3.3 Create `tsconfig.node.json`

```json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
```

---

## Phase 4: ESLint Configuration

### 4.1 Create `eslint.config.js`

```javascript
import js from "@eslint/js";
import globals from "globals";
import reactHooks from "eslint-plugin-react-hooks";
import reactRefresh from "eslint-plugin-react-refresh";
import tseslint from "typescript-eslint";

export default tseslint.config(
  { ignores: ["dist"] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      "react-hooks": reactHooks,
      "react-refresh": reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      "react-refresh/only-export-components": [
        "warn",
        { allowConstantExport: true },
      ],
    },
  },
);
```

---

## Phase 5: shadcn/ui Configuration

### 5.1 Create `components.json`

```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/frontend/entrypoints/application.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
```

---

## Phase 6: Typelizer Configuration

### 6.1 Create `config/initializers/typelizer.rb`

```ruby
Typelizer.configure do |config|
  config.output_dir = Rails.root.join("app/frontend/types/api")
  config.types_import_path = "@/types/api"
end

Typelizer.dirs = [
  Rails.root.join("app", "resources")
]
```

> **Note:** Types go to `types/api/` to leave room for custom types in `types/`.

---

## Phase 7: Frontend Directory Structure

```
app/frontend/
├── api/                    # API client functions
│   └── utils.ts
├── components/
│   ├── ui/                 # shadcn components
│   │   └── button.tsx
│   └── app/                # App-specific components
├── entrypoints/
│   ├── application.css     # Tailwind + shadcn theme
│   ├── application.js      # Vite entry (axios config)
│   └── main.tsx            # React app entry
├── hooks/                  # Custom React hooks
├── lib/
│   └── utils.ts            # cn() utility
├── types/                  # Typelizer generated types
│   └── index.ts
├── views/                  # Page components
│   └── layout.tsx
└── index.ts
```

---

## Phase 8: Core Frontend Files

### 8.1 Create `app/frontend/entrypoints/application.css`

Full Tailwind v4 + shadcn theme with CSS variables (see reference file).

Key imports:

```css
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

:root {
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  /* ... all theme variables */
}

.dark {
  /* ... dark mode variables */
}

@theme inline {
  /* ... Tailwind theme mapping */
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
```

### 8.2 Create `app/frontend/entrypoints/application.js`

```javascript
import axios from "axios";

const csrfToken = document
  .querySelector('meta[name="csrf-token"]')
  ?.getAttribute("content");
if (csrfToken) {
  axios.defaults.headers.common["X-CSRF-Token"] = csrfToken;
}
axios.defaults.headers.common["Accept"] = "application/json";
axios.defaults.headers.common["Content-Type"] = "application/json";

console.log("Vite ⚡️ Rails");

import "./main";
```

### 8.3 Create `app/frontend/entrypoints/main.tsx`

```tsx
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { Routes, Route, BrowserRouter } from "react-router";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

import Layout from "@/views/layout";

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: false,
      staleTime: 5 * 60 * 1000,
      gcTime: 10 * 60 * 1000,
    },
  },
});

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <Routes>
          <Route element={<Layout />}>
            <Route index element={<div>Home</div>} />
          </Route>
        </Routes>
      </BrowserRouter>
    </QueryClientProvider>
  </StrictMode>,
);
```

### 8.4 Create `app/frontend/lib/utils.ts`

```typescript
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

### 8.5 Create `app/frontend/views/layout.tsx`

```tsx
import { Outlet } from "react-router";

export default function Layout() {
  return (
    <div className="min-h-screen bg-background">
      <main>
        <Outlet />
      </main>
    </div>
  );
}
```

### 8.6 Create `app/frontend/types/index.ts`

```typescript
// Typelizer will generate types here
export {};
```

### 8.7 Create `app/frontend/index.ts`

```typescript
// Re-export common utilities
export * from "./lib/utils";
```

---

## Phase 9: Rails Layout Update

### 9.1 Update `app/views/layouts/application.html.erb`

```erb
<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">

    <%= vite_stylesheet_tag "application" %>
    <%= vite_client_tag %>
    <%= vite_react_refresh_tag %>
    <%= vite_javascript_tag 'application' %>
  </head>

  <body>
    <%= yield %>
  </body>
</html>
```

### 9.2 Create React mount point view

Create `app/views/spa/index.html.erb`:

```erb
<div id="root"></div>
```

### 9.3 Add SPA controller

Create `app/controllers/spa_controller.rb`:

```ruby
class SpaController < ApplicationController
  def index
    render layout: "application"
  end
end
```

### 9.4 Update routes for SPA

In `config/routes.rb`:

```ruby
# SPA routes (authenticated) - place after API routes, before catch-all
get "/app", to: "spa#index", as: :spa_root
get "/app/*path", to: "spa#index"
```

> **Note:** Root stays standard Rails. SPA lives under `/app` and requires authentication (see `02.auth.md`).

---

## Phase 10: package.json Scripts

Update `package.json` scripts:

```json
{
  "scripts": {
    "lint": "eslint .",
    "type-check": "tsc --noEmit",
    "test": "vitest",
    "test:watch": "vitest --watch"
  }
}
```

---

## Phase 11: Install shadcn Components

After setup, install components:

```bash
npx shadcn@latest add button
npx shadcn@latest add input
npx shadcn@latest add label
npx shadcn@latest add dialog
# ... add more as needed
```

---

## Execution Checklist

- [ ] Install npm packages (Phase 1)
- [ ] Create `config/vite.json` (Phase 2.1)
- [ ] Update `vite.config.ts` (Phase 2.2)
- [ ] Create `vitest.config.ts` (Phase 2.3)
- [ ] Create `vitest.setup.ts` (Phase 2.4)
- [ ] Update `tsconfig.json` (Phase 3.1)
- [ ] Create `tsconfig.app.json` (Phase 3.2)
- [ ] Create `tsconfig.node.json` (Phase 3.3)
- [ ] Create `eslint.config.js` (Phase 4.1)
- [ ] Create `components.json` (Phase 5.1)
- [ ] Create `config/initializers/typelizer.rb` (Phase 6.1)
- [ ] Create frontend directory structure (Phase 7)
- [ ] Create `app/frontend/entrypoints/application.css` (Phase 8.1)
- [ ] Create `app/frontend/entrypoints/application.js` (Phase 8.2)
- [ ] Create `app/frontend/entrypoints/main.tsx` (Phase 8.3)
- [ ] Create `app/frontend/lib/utils.ts` (Phase 8.4)
- [ ] Create `app/frontend/views/layout.tsx` (Phase 8.5)
- [ ] Create `app/frontend/types/index.ts` (Phase 8.6)
- [ ] Create `app/frontend/index.ts` (Phase 8.7)
- [ ] Update `app/views/layouts/application.html.erb` (Phase 9.1)
- [ ] Create `app/views/spa/index.html.erb` (Phase 9.2)
- [ ] Create `app/controllers/spa_controller.rb` (Phase 9.3)
- [ ] Update routes (Phase 9.4)
- [ ] Update package.json scripts (Phase 10)
- [ ] Install shadcn components (Phase 11)
- [ ] Run `bin/vite dev` to verify
- [ ] Run `npm run type-check` to verify TypeScript
- [ ] Run `npm test` to verify Vitest

---

## Verification Commands

```bash
# Start Rails + Vite
bin/dev

# Or separately:
bin/rails server
bin/vite dev

# Type check
npm run type-check

# Run frontend tests
npm test

# Generate types from Alba resources
bin/rails typelizer:generate
```

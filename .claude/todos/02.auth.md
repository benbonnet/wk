# Auth0 Authentication Setup with Devise

Reference: `../history/nvoi-claude/rails-claude-content/tmp/data/repositories/.../`

---

## Prerequisites

- Devise gem (already in Gemfile)
- omniauth-auth0 gem (already in Gemfile)
- AUTH0_CREDS initializer (already created at `config/initializers/auth0.rb`)

---

## Phase 1: Update User Model for Devise + Auth0

### 1.1 Generate Devise migration for User

The User model already exists. Add devise columns:

```bash
bin/rails generate migration AddDeviseToUsers
```

Edit the migration:

```ruby
class AddDeviseToUsers < ActiveRecord::Migration[8.0]
  def change
    # Devise doesn't require password for omniauth-only
    # Keep existing columns: login, auth0_id, name, email, avatar_url, access_token, last_login_at, internal

    # Rename auth0_id to match devise convention (optional, or keep as-is)
    # The auth0_id column already exists and is used for omniauth lookup
  end
end
```

> **Note:** User model already has `auth0_id` column which serves as the omniauth uid.

### 1.2 Update User model

Edit `app/models/user.rb`:

```ruby
# frozen_string_literal: true

class User < ApplicationRecord
  devise :omniauthable, omniauth_providers: [:auth0]

  has_many :workspace_users, dependent: :destroy
  has_many :workspaces, through: :workspace_users

  validates :login, presence: true, uniqueness: true
  validates :auth0_id, presence: true, uniqueness: true

  def self.from_omniauth(auth)
    find_by(auth0_id: auth.uid)
  end
end
```

---

## Phase 2: Devise Routes

### 2.1 Update `config/routes.rb`

```ruby
Rails.application.routes.draw do
  # Devise with Auth0
  devise_for :users, controllers: {
    omniauth_callbacks: "users/omniauth_callbacks"
  }

  # Health check
  get "up" => "rails/health#show", as: :rails_health_check

  # API routes (if any)
  # namespace :api do
  #   ...
  # end

  # SPA routes (authenticated)
  get "/app", to: "spa#index", as: :spa_root
  get "/app/*path", to: "spa#index"

  # Root - standard Rails landing
  root "home#index"
end
```

---

## Phase 3: OmniAuth Callbacks Controller

### 3.1 Create `app/controllers/users/omniauth_callbacks_controller.rb`

```ruby
# frozen_string_literal: true

class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  def auth0
    @user = User.from_omniauth(request.env["omniauth.auth"])

    if @user
      @user.update_columns(last_login_at: Time.current)
      sign_in_and_redirect @user, event: :authentication
    else
      # User not found - redirect to login or show error
      redirect_to new_user_session_path, alert: "User not found. Please contact support."
    end
  end

  def failure
    redirect_to root_path, alert: "Authentication failed."
  end

  protected

  def after_sign_in_path_for(resource)
    spa_root_path
  end

  def after_sign_out_path_for(resource_or_scope)
    auth0_logout_url
  end

  private

  def auth0_logout_url
    domain = AUTH0_CREDS[:domain]
    client_id = AUTH0_CREDS[:client_id]
    return_to = root_url

    "https://#{domain}/v2/logout?client_id=#{client_id}&returnTo=#{CGI.escape(return_to)}"
  end
end
```

---

## Phase 4: SPA Controller with Authentication

### 4.1 Create `app/controllers/spa_controller.rb`

```ruby
# frozen_string_literal: true

class SpaController < ApplicationController
  before_action :authenticate_user!

  def index
    render layout: "application"
  end
end
```

### 4.2 Create `app/views/spa/index.html.erb`

```erb
<div id="root"></div>
```

---

## Phase 5: Home Controller (Public Landing)

### 5.1 Create `app/controllers/home_controller.rb`

```ruby
# frozen_string_literal: true

class HomeController < ApplicationController
  def index
    redirect_to spa_root_path if user_signed_in?
  end
end
```

### 5.2 Create `app/views/home/index.html.erb`

```erb
<div class="min-h-screen flex items-center justify-center bg-background">
  <div class="text-center">
    <h1 class="text-4xl font-bold mb-8">Welcome</h1>
    <%= link_to "Sign in with Auth0", user_auth0_omniauth_authorize_path,
        method: :post,
        data: { turbo: false },
        class: "inline-flex items-center px-6 py-3 bg-primary text-primary-foreground rounded-md hover:bg-primary/90" %>
  </div>
</div>
```

---

## Phase 6: Application Controller

### 6.1 Update `app/controllers/application_controller.rb`

```ruby
# frozen_string_literal: true

class ApplicationController < ActionController::Base
  # Only allow modern browsers supporting webp images, web push, badges, import maps, CSS nesting, and CSS :has.
  allow_browser versions: :modern

  protected

  def after_sign_in_path_for(resource)
    spa_root_path
  end

  def after_sign_out_path_for(resource_or_scope)
    root_path
  end
end
```

---

## Phase 7: Logout Flow

### 7.1 Create logout route

In `config/routes.rb`, add:

```ruby
# Custom logout that also logs out of Auth0
delete "/logout", to: "sessions#destroy", as: :logout
```

### 7.2 Create `app/controllers/sessions_controller.rb`

```ruby
# frozen_string_literal: true

class SessionsController < ApplicationController
  def destroy
    sign_out current_user
    redirect_to auth0_logout_url, allow_other_host: true
  end

  private

  def auth0_logout_url
    domain = AUTH0_CREDS[:domain]
    client_id = AUTH0_CREDS[:client_id]
    return_to = root_url

    "https://#{domain}/v2/logout?client_id=#{client_id}&returnTo=#{CGI.escape(return_to)}"
  end
end
```

---

## Phase 8: Frontend Current User API

### 8.1 Create API endpoint for current user

Create `app/controllers/api/v1/me_controller.rb`:

```ruby
# frozen_string_literal: true

module Api
  module V1
    class MeController < ApplicationController
      before_action :authenticate_user!

      def show
        render json: UserResource.new(current_user)
      end
    end
  end
end
```

### 8.2 Create User resource (Alba serializer)

Create `app/resources/user_resource.rb`:

```ruby
# frozen_string_literal: true

class UserResource
  include Alba::Resource

  root_key :user

  attributes :id, :login, :name, :email, :avatar_url, :internal
end
```

### 8.3 Add API route

In `config/routes.rb`:

```ruby
namespace :api do
  namespace :v1 do
    resource :me, only: [:show], controller: "me"
  end
end
```

---

## Phase 9: Frontend Auth Integration

### 9.1 Create `app/frontend/api/auth.ts`

```typescript
import axios from "axios";
import type { User } from "@/types/api";

export async function getCurrentUser(): Promise<User> {
  const response = await axios.get<{ user: User }>("/api/v1/me");
  return response.data.user;
}

export function getLoginUrl(): string {
  return "/users/auth/auth0";
}

export function getLogoutUrl(): string {
  return "/logout";
}
```

### 9.2 Create auth hook `app/frontend/hooks/use-auth.ts`

```typescript
import { useQuery } from "@tanstack/react-query";
import { getCurrentUser } from "@/api/auth";

export function useAuth() {
  const {
    data: user,
    isLoading,
    error,
  } = useQuery({
    queryKey: ["currentUser"],
    queryFn: getCurrentUser,
    retry: false,
    staleTime: 5 * 60 * 1000,
  });

  return {
    user,
    isLoading,
    isAuthenticated: !!user,
    error,
  };
}
```

### 9.3 Update layout to use auth

Update `app/frontend/views/layout.tsx`:

```tsx
import { Outlet, Navigate } from "react-router";
import { useAuth } from "@/hooks/use-auth";

export default function Layout() {
  const { user, isLoading, isAuthenticated } = useAuth();

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div>Loading...</div>
      </div>
    );
  }

  if (!isAuthenticated) {
    // Redirect to Rails login
    window.location.href = "/users/auth/auth0";
    return null;
  }

  return (
    <div className="min-h-screen bg-background">
      <header className="border-b">
        <div className="container mx-auto px-4 py-3 flex justify-between items-center">
          <span className="font-semibold">{user?.name || user?.login}</span>
          <a
            href="/logout"
            className="text-sm text-muted-foreground hover:text-foreground"
          >
            Logout
          </a>
        </div>
      </header>
      <main>
        <Outlet />
      </main>
    </div>
  );
}
```

---

## Phase 10: Environment Variables

### 10.1 Required ENV variables

```bash
AUTH0_CLIENT_ID=your_client_id
AUTH0_CLIENT_SECRET=your_client_secret
AUTH0_DOMAIN=your-tenant.auth0.com
AUTH0_AUDIENCE=https://your-api-identifier
```

### 10.2 Auth0 Dashboard Configuration

1. **Allowed Callback URLs:**

   - `http://localhost:3000/users/auth/auth0/callback`
   - `https://your-domain.com/users/auth/auth0/callback`

2. **Allowed Logout URLs:**

   - `http://localhost:3000`
   - `https://your-domain.com`

3. **Allowed Web Origins:**
   - `http://localhost:3000`
   - `https://your-domain.com`

---

## Execution Checklist

- [ ] Update User model with devise (Phase 1.2)
- [ ] Update routes (Phase 2.1)
- [ ] Create OmniAuth callbacks controller (Phase 3.1)
- [ ] Create SPA controller (Phase 4.1)
- [ ] Create SPA view (Phase 4.2)
- [ ] Create Home controller (Phase 5.1)
- [ ] Create Home view (Phase 5.2)
- [ ] Update Application controller (Phase 6.1)
- [ ] Create Sessions controller (Phase 7.2)
- [ ] Create API Me controller (Phase 8.1)
- [ ] Create User resource (Phase 8.2)
- [ ] Add API routes (Phase 8.3)
- [ ] Create frontend auth API (Phase 9.1)
- [ ] Create useAuth hook (Phase 9.2)
- [ ] Update frontend layout (Phase 9.3)
- [ ] Configure Auth0 dashboard (Phase 10.2)
- [ ] Set environment variables (Phase 10.1)

---

## Verification

```bash
# Start server
bin/dev

# Visit http://localhost:3000
# Should see login page

# Click "Sign in with Auth0"
# Should redirect to Auth0 login

# After login, should redirect to /app
# API call to /api/v1/me should return current user
```

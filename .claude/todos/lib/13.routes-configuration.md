# Routes Configuration - Single Source of Truth

## Problem Statement

View manually specifies `url` and `api` in DSL, but Registry derives `namespace` and `feature` from pack structure. No connection between them leads to mismatches.

Example:

- Registry derives: `namespace: :workspaces`, `feature: :rib_check_requests`
- View specifies: `url "/api/v1/workspaces/rib_requests"` (WRONG - typo undetected)

## Solution

**API routes:** 100% derived from Registry. No manual specification.
**Frontend routes:** Default derived, overridable via `frontend_route`.

---

## Implementation Steps

### Step 1: Add view_config method to Registry

**File:** `packs/core/app/lib/core/features/registry.rb`

Add constant and methods:

```ruby
API_PREFIX = "/api/v1"

class << self
  # Generate complete view config with derived URL and API
  # @param namespace [String, Symbol] e.g., "workspaces"
  # @param feature [String, Symbol] e.g., "rib_check_requests"
  # @param view_name [String, Symbol] e.g., "index"
  # @return [Hash, nil] Complete view config or nil if not found
  def view_config(namespace, feature, view_name)
    view_class = find_view(namespace, feature, view_name)
    return nil unless view_class&.respond_to?(:has_view?) && view_class.has_view?

    # Get raw config from view (layout, translations, drawers - no URL/API)
    config = view_class.view_config_raw

    # Inject URL from Registry (single source of truth)
    config[:url] = "#{API_PREFIX}/#{namespace}/#{feature}"

    # Inject API from tools in same feature
    config[:api] = derive_api_for_feature(namespace, feature)

    config
  end

  # Derive API registry from tools in a feature
  # @param namespace [String, Symbol]
  # @param feature [String, Symbol]
  # @return [Hash] API registry { action => { method:, path: } }
  def derive_api_for_feature(namespace, feature)
    feature_config = find(namespace, feature)
    return {} unless feature_config

    api = {}
    feature_config[:tools].each do |tool_class|
      next unless tool_class.respond_to?(:route_config) && tool_class.route_config

      route = tool_class.route_config
      tool_name = tool_class.name.demodulize.underscore.to_sym

      # Build path from scope and action
      path = route[:scope] == :member ? ":id" : ""
      if route[:action]
        path = path.empty? ? route[:action].to_s : "#{path}/#{route[:action]}"
      end

      api[tool_name] = {
        method: route[:method].to_s.upcase,
        path: path
      }
    end

    api
  end
end
```

### Step 2: Rename view_config to view_config_raw in BaseView

**File:** `packs/ui/app/lib/ui/views/base_view.rb`

Change method name from `view_config` to `view_config_raw`:

```ruby
module ClassMethods
  # RENAME: view_config -> view_config_raw
  # Returns raw view config WITHOUT url/api (those come from Registry)
  def view_config_raw
    return @view_config_raw if @view_config_raw

    builder = ViewBuilder.new(schema_class: resolve_schema_class)
    builder.instance_eval(&@view_block)
    @view_config_raw = builder.to_ui_schema
  end
end
```

### Step 3: Remove url and api from ViewBuilder

**File:** `packs/ui/app/lib/ui/views/view_builder.rb`

Update `attr_reader` (remove `api_registry`):

```ruby
# Before:
attr_reader :elements, :api_registry, :drawers_registry

# After:
attr_reader :elements, :drawers_registry
```

Update `initialize` (remove `@url_value` and `@api_registry`):

```ruby
def initialize(schema_class: nil)
  @elements = []
  # REMOVE: @api_registry = {}
  @drawers_registry = {}
  @translations_data = {}
  # REMOVE: @url_value = nil
  @schema_class = schema_class
  @field_prefix = nil
end
```

Delete these methods entirely:

```ruby
# DELETE THIS METHOD:
def url(path)
  @url_value = path
end

# DELETE THIS METHOD:
def api(&block)
  builder = Builders::ApiBuilder.new
  yield(builder)
  @api_registry = builder.endpoints
end
```

Update `to_ui_schema` to remove url/api:

```ruby
def to_ui_schema
  {
    type: "VIEW",
    # REMOVE: url: @url_value,
    translations: @translations_data.empty? ? nil : @translations_data,
    # REMOVE: api: @api_registry.empty? ? nil : @api_registry,
    drawers: @drawers_registry.empty? ? nil : @drawers_registry,
    elements: @elements
  }.compact
end
```

Also delete `ApiBuilder` class if it exists solely for this purpose.

### Step 4: Move ViewsController to packs/core

**Move controller to core pack (follows existing convention):**

1. **Delete:** `app/controllers/api/v1/views_controller.rb`

2. **Create:** `packs/core/app/controllers/core/v1/views_controller.rb`

```ruby
# frozen_string_literal: true

module Core
  module V1
    class ViewsController < ApplicationController
      # GET /api/v1/views/:namespace/:feature/:view_name
      def show
        config = Core::Features::Registry.view_config(
          params[:namespace],
          params[:feature],
          params[:view_name]
        )

        if config.nil?
          render json: { error: "View not found" }, status: :not_found
          return
        end

        render json: config
      end
    end
  end
end
```

3. **Delete old route:** `config/routes.rb`

Remove line 22:

```ruby
# DELETE THIS LINE:
get "views/:namespace/:feature/:view_name", to: "views#show"
```

4. **Add route to core:** `packs/core/config/routes/core.rb`

Add inside `namespace :v1` block (after `resources :routes`):

```ruby
resources :views, only: [] do
  get ":namespace/:feature/:view_name", action: :show, on: :collection
end
```

Full routes file becomes:

```ruby
namespace :core, path: "api" do
  namespace :v1 do
    resources :routes, only: [:index]
    resources :views, only: [] do
      get ":namespace/:feature/:view_name", action: :show, on: :collection
    end

    scope ":namespace" do
      # ... existing resource routes
    end
  end
end
```

### Step 5: Update frontend_routes default

**File:** `packs/core/app/lib/core/features/registry.rb`

Update the `frontend_routes` method to provide default when `frontend_route` not specified:

```ruby
def self.frontend_routes
  routes = []

  all.each do |namespace, features|
    features.each do |feature_name, config|
      config[:views].each do |view_class|
        # Only include routable views (with frontend_route) or index views (default)
        view_name = view_class.name.demodulize.underscore

        # Determine frontend path
        path = if view_class.respond_to?(:frontend_route) && view_class.frontend_route
          # Custom path specified
          view_class.frontend_route
        elsif view_name == "index"
          # Default: /feature-name for index views
          "/#{feature_name.to_s.tr('_', '-')}"
        else
          # Non-index views without frontend_route are not routable
          next
        end

        routes << {
          path: path,
          namespace: namespace.to_s,
          feature: feature_name.to_s,
          view: view_name
        }
      end
    end
  end

  routes
end
```

### Step 6: Remove url/api from view files

**File:** `packs/rib_check_workflow/app/lib/rib_check_workflow/views/index.rb`

Remove these blocks:

```ruby
# DELETE THIS:
url "/api/v1/workspaces/rib_requests"

# DELETE THIS:
api do |a|
  a.index method: :get, path: ""
  a.show method: :get, path: ":id"
  a.create method: :post, path: ""
  a.update method: :patch, path: ":id"
  a.destroy method: :delete, path: ":id"
  a.cancel method: :post, path: ":id/cancel"
end
```

Keep only:

```ruby
frontend_route "/rib-checks"

view do
  translations(...)
  drawers do |d|
    ...
  end
  page(...) do |c|
    ...
  end
end
```

**File:** `packs/contacts_service/app/lib/contacts_service/views/index.rb`

Same changes - remove `url` and `api` blocks.

### Step 7: Update Sync to use Registry.view_config

**File:** `packs/core/app/lib/core/sync.rb`

In `sync_views` method, update to use Registry.view_config:

```ruby
def sync_views(feature, views)
  # Get namespace from feature config
  namespace = feature.config.dig("namespace")&.to_sym || :workspaces

  views.each do |view_class|
    view_slug = view_class.name.demodulize.underscore

    existing = ::FeatureView.find_by(slug: view_slug, feature_id: feature.id)
    next if existing

    # Before:
    # view_config = view_class.respond_to?(:view_config) && view_class.respond_to?(:has_view?) && view_class.has_view? ? view_class.view_config : nil

    # After - use Registry.view_config for complete config with derived URL/API:
    view_config = if view_class.respond_to?(:has_view?) && view_class.has_view?
      Core::Features::Registry.view_config(namespace, feature.identifier.to_sym, view_slug)
    else
      nil
    end

    ::FeatureView.create!(
      feature_id: feature.id,
      title: view_slug.titleize,
      slug: view_slug,
      config: view_config
    )

    log "Synced view: #{feature.identifier}/#{view_slug}"
  end
end
```

### Step 8: Update mock export task

**File:** `packs/core/lib/tasks/core.rake`

Update `export_pack_views` to use `Registry.view_config`:

```ruby
def export_pack_views(pack_name, output_dir, silent: false)
  pack_module = pack_name.camelize
  views_dir = output_dir.join("views")

  Core::Features::Registry.all.each do |namespace, features|
    features.each do |feature_slug, config|
      config[:views].each do |view_class|
        next unless view_class.name&.start_with?(pack_module)
        next unless view_class.respond_to?(:has_view?) && view_class.has_view?

        FileUtils.mkdir_p(views_dir)
        view_slug = view_class.name.demodulize.underscore

        # Before:
        # File.write(view_file, JSON.pretty_generate(view_class.view_config))

        # After - use Registry.view_config for complete config with derived URL/API:
        view_config = Core::Features::Registry.view_config(namespace, feature_slug, view_slug)
        next unless view_config

        view_file = views_dir.join("#{feature_slug}_#{view_slug}.json")
        File.write(view_file, JSON.pretty_generate(view_config))
        puts "#{pack_name}: Exported view #{feature_slug}/#{view_slug}" unless silent
      end
    end
  end
end
```

### Step 9: Update tests

**File:** `packs/ui/spec/lib/ui/views/base_view_spec.rb`

Update to test `view_config_raw` instead of `view_config`:

```ruby
describe ".view_config_raw" do
  it "returns schema without url or api" do
    config = test_class.view_config_raw
    expect(config).not_to have_key(:url)
    expect(config).not_to have_key(:api)
    expect(config[:type]).to eq("VIEW")
  end
end
```

**File:** `packs/core/spec/lib/core/features/registry_spec.rb`

Add tests for `view_config`:

```ruby
describe ".view_config" do
  it "returns complete config with derived url" do
    config = described_class.view_config(:workspaces, :contacts, :index)
    expect(config[:url]).to eq("/api/v1/workspaces/contacts")
  end

  it "derives api from tools" do
    config = described_class.view_config(:workspaces, :contacts, :index)
    expect(config[:api]).to include(:index, :create, :show, :update, :destroy)
  end
end
```

---

## Validation Checklist

After implementation, verify:

- [ ] Registry has `API_PREFIX = "/api/v1"` constant
- [ ] ViewBuilder has no `url` method
- [ ] ViewBuilder has no `api` method
- [ ] All view files have no `url` or `api do` blocks
- [ ] BaseView has `view_config_raw` (not `view_config`)
- [ ] Registry has `view_config(namespace, feature, view_name)`
- [ ] Registry has `derive_api_for_feature(namespace, feature)`
- [ ] ViewsController moved to `packs/core/app/controllers/core/v1/views_controller.rb`
- [ ] ViewsController calls `Registry.view_config`
- [ ] Views route added to `packs/core/config/routes/core.rb`
- [ ] Old `app/controllers/api/v1/views_controller.rb` deleted
- [ ] Old views route deleted from `config/routes.rb`
- [ ] `frontend_routes` provides default for index views
- [ ] Mocks regenerated: `bin/rails core:export_mocks`
- [ ] All tests pass: `yarn test --run && bin/rspec`
- [ ] Browser test: `/rib-checks` → API calls hit `/api/v1/workspaces/rib_check_requests`

---

## Files Changed Summary

| File                                                                 | Changes                                                                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| `packs/core/app/lib/core/features/registry.rb`                       | Add `API_PREFIX`, `view_config`, `derive_api_for_feature`; update `frontend_routes` |
| `packs/ui/app/lib/ui/views/base_view.rb`                             | Rename `view_config` → `view_config_raw`                                            |
| `packs/ui/app/lib/ui/views/view_builder.rb`                          | Remove `url`, `api` methods; update `to_ui_schema`                                  |
| `app/controllers/api/v1/views_controller.rb`                         | **DELETE**                                                                          |
| `packs/core/app/controllers/core/v1/views_controller.rb`             | **CREATE** - moved from app/, use `Registry.view_config`                            |
| `config/routes.rb`                                                   | **DELETE** views route (line 22)                                                    |
| `packs/core/config/routes/core.rb`                                   | Add views route                                                                     |
| `packs/core/app/lib/core/sync.rb`                                    | Update view_config calls                                                            |
| `packs/core/lib/tasks/core.rake`                                     | Update `export_pack_views`                                                          |
| `packs/rib_check_workflow/app/lib/rib_check_workflow/views/index.rb` | Remove `url`, `api`                                                                 |
| `packs/contacts_service/app/lib/contacts_service/views/index.rb`     | Remove `url`, `api`                                                                 |
| `packs/ui/spec/lib/ui/views/base_view_spec.rb`                       | Test `view_config_raw`                                                              |
| `packs/core/spec/lib/core/features/registry_spec.rb`                 | Test `view_config`                                                                  |

# UI Confirm Dialog Implementation

## Objective

Replace `window.confirm()` with a custom styled AlertDialog component supporting icon, color, title, description, and customizable button labels.

---

## New Confirm Options Interface

```typescript
interface ConfirmOptions {
  title?: string; // default from global: "confirm_title"
  description?: string; // default from global: "confirm_description"
  icon?: string; // lucide icon name, default: "alert-triangle"
  variant?: "default" | "destructive"; // default: "destructive"
  cancelLabel?: string; // default from global: "confirm_cancel"
  confirmLabel?: string; // default from global: "confirm_ok"
}
```

All fields are optional with defaults from global translations.

---

## Implementation Steps

### Step 0: Add Global Translations Infrastructure

This step makes `config/locales/*.yml` available to all frontend views.

#### 0.1 Create/update locale files

**File:** `config/locales/en.yml`

```yaml
en:
  ui:
    confirm_title: "Confirm this action?"
    confirm_description: "This action cannot be undone. This will permanently archive this record."
    confirm_cancel: "Cancel"
    confirm_ok: "Confirm"
```

**File:** `config/locales/fr.yml` (CREATE)

```yaml
fr:
  ui:
    confirm_title: "Confirmer cette action?"
    confirm_description: "Cette action est irreversible. Cet enregistrement sera archiv√© definitivement."
    confirm_cancel: "Annuler"
    confirm_ok: "Confirmer"
```

#### 0.2 Update Registry to merge global translations

**File:** `packs/core/app/lib/core/features/registry.rb`

In `view_config` method, change from:

```ruby
def view_config(namespace, feature, view_name)
  view_class = find_view(namespace, feature, view_name)
  return nil unless view_class&.respond_to?(:has_view?) && view_class.has_view?

  config = view_class.view_config_raw
  config[:url] = "#{API_PREFIX}/#{namespace}/#{feature}"
  config[:api] = derive_api_for_feature(namespace, feature)

  config
end
```

To:

```ruby
def view_config(namespace, feature, view_name)
  view_class = find_view(namespace, feature, view_name)
  return nil unless view_class&.respond_to?(:has_view?) && view_class.has_view?

  config = view_class.view_config_raw
  config[:url] = "#{API_PREFIX}/#{namespace}/#{feature}"
  config[:api] = derive_api_for_feature(namespace, feature)

  # Restructure translations: { global: from_i18n, views: from_view_dsl }
  config[:translations] = {
    global: global_translations,
    views: config[:translations]
  }

  config
end
```

Add private method at end of class (inside `class << self`):

```ruby
def global_translations
  result = {}
  I18n.available_locales.each do |locale|
    result[locale] = I18n.t("ui", locale: locale, default: {})
  end
  result
end
```

#### 0.3 Update frontend TranslationsMap type

**File:** `packs/ui/app/frontend/lib/ui-renderer/types.ts`

Change `TranslationsMap` from:

```typescript
export interface TranslationsMap {
  schemas: Record<string, Record<string, string>>;
  views: Record<string, Record<string, string>>;
  common: Record<string, string>;
}
```

To:

```typescript
export interface TranslationsMap {
  global: Record<string, Record<string, string>>; // from config/locales/*.yml
  views: Record<string, Record<string, string>>; // from view DSL
}
```

#### 0.4 Update frontend translate function

**File:** `packs/ui/app/frontend/lib/ui-renderer/provider.tsx`

Update the `t` function to look up: `views[locale][key]` first, then `global[locale][key]`:

```typescript
const t = useCallback(
  (key: string): string => {
    if (!translations) return key;

    const locale = currentLocale;

    // Try views first (view-specific translations)
    const viewValue = translations.views?.[locale]?.[key];
    if (viewValue) return viewValue;

    // Fall back to global (from config/locales/*.yml)
    const globalValue = translations.global?.[locale]?.[key];
    if (globalValue) return globalValue;

    return key;
  },
  [translations, currentLocale]
);
```

---

### Step 1: Install shadcn AlertDialog

```bash
cd packs/ui && npx shadcn@latest add alert-dialog
```

This creates: `packs/ui/app/frontend/components/alert-dialog.tsx`

---

### Step 2: Update Service Interface

**File:** `packs/ui/app/frontend/lib/ui-renderer/registry.ts`

Change line 199 from:

```typescript
confirm: (message: string) => Promise<boolean>;
```

To:

```typescript
confirm: (options: ConfirmOptions) => Promise<boolean>;
```

Add interface before UIServices:

```typescript
export interface ConfirmOptions {
  title?: string;
  description?: string;
  icon?: string;
  variant?: "default" | "destructive";
  cancelLabel?: string;
  confirmLabel?: string;
}
```

---

### Step 3: Create ConfirmDialog Component

**Create file:** `packs/ui/app/frontend/components/confirm-dialog.tsx`

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@ui/components/alert-dialog";
import { AlertTriangle } from "lucide-react";
import { cn } from "@ui/lib/utils";

export interface ConfirmDialogProps {
  open: boolean;
  title: string;
  description: string;
  icon?: string;
  variant?: "default" | "destructive";
  cancelLabel: string;
  confirmLabel: string;
  onConfirm: () => void;
  onCancel: () => void;
}

export function ConfirmDialog({
  open,
  title,
  description,
  variant = "destructive",
  cancelLabel,
  confirmLabel,
  onConfirm,
  onCancel,
}: ConfirmDialogProps) {
  const isDestructive = variant === "destructive";

  return (
    <AlertDialog open={open} onOpenChange={(isOpen) => !isOpen && onCancel()}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <div className="flex items-start gap-4">
            {isDestructive && (
              <div className="flex size-10 shrink-0 items-center justify-center rounded-full bg-red-100">
                <AlertTriangle className="size-5 text-red-600" />
              </div>
            )}
            <div className="flex flex-col gap-2">
              <AlertDialogTitle>{title}</AlertDialogTitle>
              <AlertDialogDescription>{description}</AlertDialogDescription>
            </div>
          </div>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>{cancelLabel}</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            className={cn(isDestructive && "bg-red-600 hover:bg-red-700")}
          >
            {confirmLabel}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

---

### Step 4: Export from Components Index

**File:** `packs/ui/app/frontend/components/index.ts`

Add:

```typescript
export { ConfirmDialog } from "./confirm-dialog";
export type { ConfirmDialogProps } from "./confirm-dialog";
```

---

### Step 5: Update AppUIProvider

**File:** `app/frontend/providers/ui-provider.tsx`

Replace entire file:

```typescript
import { useState, useCallback } from "react";
import { UIProvider, DEFAULT_LOCALE } from "@ui/lib";
import type { UIServices, ConfirmOptions } from "@ui/lib";
import { useNavigate } from "react-router";
import axios from "axios";
import { ConfirmDialog } from "@ui/components/confirm-dialog";

interface ConfirmState {
  isOpen: boolean;
  options: ConfirmOptions | null;
  resolve: ((value: boolean) => void) | null;
}

interface AppUIProviderProps {
  children: React.ReactNode;
  translations?: Record<string, unknown>;
  locale?: string;
}

export function AppUIProvider({
  children,
  translations,
  locale = DEFAULT_LOCALE,
}: AppUIProviderProps) {
  const navigate = useNavigate();
  const [confirmState, setConfirmState] = useState<ConfirmState>({
    isOpen: false,
    options: null,
    resolve: null,
  });

  const showConfirm = useCallback(
    (options: ConfirmOptions): Promise<boolean> => {
      return new Promise((resolve) => {
        setConfirmState({
          isOpen: true,
          options,
          resolve,
        });
      });
    },
    []
  );

  const handleConfirmResponse = useCallback(
    (confirmed: boolean) => {
      if (confirmState.resolve) {
        confirmState.resolve(confirmed);
      }
      setConfirmState({
        isOpen: false,
        options: null,
        resolve: null,
      });
    },
    [confirmState]
  );

  const services: UIServices = {
    fetch: async (url, options) => {
      const response = await axios({
        url,
        method: options?.method || "GET",
        data: options?.data,
      });
      return response.data;
    },
    navigate: (path) => navigate(path),
    toast: (message) => {
      console.log(`Toast: ${message}`);
    },
    confirm: showConfirm,
  };

  return (
    <UIProvider
      services={services}
      translations={translations as never}
      locale={locale}
    >
      {children}
      {confirmState.options && (
        <ConfirmDialog
          open={confirmState.isOpen}
          title={confirmState.options.title || "Confirm"}
          description={confirmState.options.description}
          variant={confirmState.options.variant}
          cancelLabel={confirmState.options.cancelLabel || "Cancel"}
          confirmLabel={confirmState.options.confirmLabel || "Confirm"}
          onConfirm={() => handleConfirmResponse(true)}
          onCancel={() => handleConfirmResponse(false)}
        />
      )}
    </UIProvider>
  );
}
```

---

### Step 6: Update Callers to Pass Translated Options

**File:** `packs/ui/app/frontend/adapters/custom/table/table.tsx`

Change lines 334-337 from:

```typescript
if (action.confirm) {
  const confirmed = await services.confirm(t(action.confirm));
  if (!confirmed) return;
}
```

To:

```typescript
if (action.confirm) {
  const confirmed = await services.confirm({
    title: t(action.confirm.title || "confirm_title"),
    description: t(action.confirm.description || "confirm_description"),
    variant: action.confirm.variant,
    cancelLabel: t(action.confirm.cancel_label || "confirm_cancel"),
    confirmLabel: t(action.confirm.confirm_label || "confirm_ok"),
  });
  if (!confirmed) return;
}
```

**File:** `packs/ui/app/frontend/adapters/primitives/link.tsx`

Apply same pattern to line 41.

**File:** `packs/ui/app/frontend/adapters/primitives/option.tsx`

Apply same pattern to line 34.

---

### Step 7: Update UISchema Types

**File:** `packs/ui/app/frontend/lib/ui-renderer/types.ts`

Change `confirm?: string;` to:

```typescript
confirm?: {
  title?: string;
  description?: string;
  variant?: "default" | "destructive";
  cancel_label?: string;
  confirm_label?: string;
};
```

---

## Ruby DSL Usage

```ruby
link :delete, api: :destroy, confirm: {
  title: "delete_title",           # translation key (optional, defaults to "confirm_title")
  description: "delete_confirm",   # translation key (optional, defaults to "confirm_description")
  variant: "destructive",          # "default" or "destructive" (optional)
  cancel_label: "cancel",          # translation key (optional, defaults to "confirm_cancel")
  confirm_label: "delete"          # translation key (optional, defaults to "confirm_ok")
}
```

Minimal usage (all defaults from global translations):

```ruby
link :delete, api: :destroy, confirm: {}
```

No confirmation (confirm key omitted):

```ruby
link :delete, api: :destroy  # no confirm dialog, executes immediately
```

---

## Files Changed Summary

| File                                                    | Action                              |
| ------------------------------------------------------- | ----------------------------------- |
| `config/locales/en.yml`                                 | EDIT (add ui.* keys)                |
| `config/locales/fr.yml`                                 | CREATE                              |
| `packs/core/app/lib/core/features/registry.rb`          | EDIT (merge global translations)    |
| `packs/ui/app/frontend/lib/ui-renderer/types.ts`        | EDIT (TranslationsMap, confirm)     |
| `packs/ui/app/frontend/lib/ui-renderer/provider.tsx`    | EDIT (t function lookup order)      |
| `packs/ui/app/frontend/components/alert-dialog.tsx`     | CREATE (via shadcn CLI)             |
| `packs/ui/app/frontend/components/confirm-dialog.tsx`   | CREATE                              |
| `packs/ui/app/frontend/components/index.ts`             | EDIT (add exports)                  |
| `packs/ui/app/frontend/lib/ui-renderer/registry.ts`     | EDIT (ConfirmOptions interface)     |
| `packs/ui/app/frontend/adapters/custom/table/table.tsx` | EDIT (confirm handling)             |
| `packs/ui/app/frontend/adapters/primitives/link.tsx`    | EDIT (confirm handling)             |
| `packs/ui/app/frontend/adapters/primitives/option.tsx`  | EDIT (confirm handling)             |
| `app/frontend/providers/ui-provider.tsx`                | REPLACE                             |

---

## Tests

### Step 8: ConfirmDialog Component Tests

**Create file:** `packs/ui/app/frontend/components/__tests__/confirm-dialog.test.tsx`

```typescript
import { describe, it, expect, vi } from "vitest";
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { ConfirmDialog } from "../confirm-dialog";

describe("ConfirmDialog", () => {
  const defaultProps = {
    open: true,
    title: "Confirm this action?",
    description: "This cannot be undone.",
    cancelLabel: "Cancel",
    confirmLabel: "Confirm",
    onConfirm: vi.fn(),
    onCancel: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("renders title and description when open", () => {
    render(<ConfirmDialog {...defaultProps} />);
    expect(screen.getByText("Confirm this action?")).toBeInTheDocument();
    expect(screen.getByText("This cannot be undone.")).toBeInTheDocument();
  });

  it("renders cancel and confirm buttons with labels", () => {
    render(<ConfirmDialog {...defaultProps} />);
    expect(screen.getByRole("button", { name: "Cancel" })).toBeInTheDocument();
    expect(screen.getByRole("button", { name: "Confirm" })).toBeInTheDocument();
  });

  it("calls onConfirm when confirm button clicked", async () => {
    const onConfirm = vi.fn();
    render(<ConfirmDialog {...defaultProps} onConfirm={onConfirm} />);
    await userEvent.click(screen.getByRole("button", { name: "Confirm" }));
    expect(onConfirm).toHaveBeenCalledTimes(1);
  });

  it("calls onCancel when cancel button clicked", async () => {
    const onCancel = vi.fn();
    render(<ConfirmDialog {...defaultProps} onCancel={onCancel} />);
    await userEvent.click(screen.getByRole("button", { name: "Cancel" }));
    expect(onCancel).toHaveBeenCalledTimes(1);
  });

  it("does not render when open is false", () => {
    render(<ConfirmDialog {...defaultProps} open={false} />);
    expect(screen.queryByText("Confirm this action?")).not.toBeInTheDocument();
  });

  it("shows alert icon for destructive variant", () => {
    render(<ConfirmDialog {...defaultProps} variant="destructive" />);
    // AlertTriangle icon should be present
    expect(document.querySelector("svg")).toBeInTheDocument();
  });

  it("hides alert icon for default variant", () => {
    render(<ConfirmDialog {...defaultProps} variant="default" />);
    // No icon for default variant
    expect(document.querySelector(".bg-red-100")).not.toBeInTheDocument();
  });
});
```

### Step 9: Provider Translation Tests (update existing)

**File:** `packs/ui/app/frontend/lib/ui-renderer/__tests__/provider.test.tsx`

Add tests for global + views translation lookup:

```typescript
describe("translation lookup order", () => {
  it("returns view translation when key exists in views", () => {
    const translations = {
      global: { en: { confirm_title: "Global Confirm" } },
      views: { en: { confirm_title: "View Confirm" } },
    };
    // views takes precedence
    // test t("confirm_title") returns "View Confirm"
  });

  it("falls back to global when key not in views", () => {
    const translations = {
      global: { en: { confirm_cancel: "Cancel" } },
      views: { en: {} },
    };
    // test t("confirm_cancel") returns "Cancel" from global
  });

  it("returns key when not found in views or global", () => {
    const translations = {
      global: { en: {} },
      views: { en: {} },
    };
    // test t("unknown_key") returns "unknown_key"
  });
});
```

---

## Files Changed Summary

| File                                                    | Action                              |
| ------------------------------------------------------- | ----------------------------------- |
| `config/locales/en.yml`                                 | EDIT (add ui.* keys)                |
| `config/locales/fr.yml`                                 | CREATE                              |
| `packs/core/app/lib/core/features/registry.rb`          | EDIT (merge global translations)    |
| `packs/ui/app/frontend/lib/ui-renderer/types.ts`        | EDIT (TranslationsMap, confirm)     |
| `packs/ui/app/frontend/lib/ui-renderer/provider.tsx`    | EDIT (t function lookup order)      |
| `packs/ui/app/frontend/components/alert-dialog.tsx`     | CREATE (via shadcn CLI)             |
| `packs/ui/app/frontend/components/confirm-dialog.tsx`   | CREATE                              |
| `packs/ui/app/frontend/components/__tests__/confirm-dialog.test.tsx` | CREATE               |
| `packs/ui/app/frontend/components/index.ts`             | EDIT (add exports)                  |
| `packs/ui/app/frontend/lib/ui-renderer/registry.ts`     | EDIT (ConfirmOptions interface)     |
| `packs/ui/app/frontend/lib/ui-renderer/__tests__/provider.test.tsx` | EDIT (add translation tests) |
| `packs/ui/app/frontend/adapters/custom/table/table.tsx` | EDIT (confirm handling)             |
| `packs/ui/app/frontend/adapters/primitives/link.tsx`    | EDIT (confirm handling)             |
| `packs/ui/app/frontend/adapters/primitives/option.tsx`  | EDIT (confirm handling)             |
| `app/frontend/providers/ui-provider.tsx`                | REPLACE                             |

---

## Do NOT

- Do not modify Ruby DSL builders - `confirm:` already passes through as-is
- Do not accept `confirm: "string"` format - always use object `confirm: {}`
- Do not hardcode English strings in ConfirmDialog component - all labels come from callers (already translated)

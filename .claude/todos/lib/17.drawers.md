# 17. Drawer System Refactor

## Problem

Current implementation causes infinite loop / browser crash when clicking table row to open drawer.

## Root Cause

Current DynamicRenderer passes `data` prop down the tree + passes `elements` as prop AND renders children = double rendering + cascading re-renders.

## Solution

Replicate exactly what `../2025-CRM-REGTECH` does.

---

## Reference: How 2025-CRM-REGTECH Does It

### 1. DynamicRenderer (`/frontend/app/lib/ui/renderer/dynamic-renderer.tsx`)

```tsx
// NO data prop
// Passes uiSchemaNode + renderer (itself) to component
// Component is responsible for rendering its own children

export const DynamicRenderer: FC<{ uiSchema: UISchemaInterface }> = ({
  uiSchema,
}) => {
  const Component = rendererRegistry[uiSchema.type];
  if (!Component) return null;

  return <Component uiSchemaNode={uiSchema} renderer={DynamicRenderer} />;
};
```

**Key**: No `data` prop. No rendering children here. Just pass schema + renderer reference.

---

### 2. ViewRenderer (`/frontend/app/lib/ui/layouts/view.tsx`)

```tsx
export const ViewRenderer: FC<RecursiveRendererProps> = ({
  uiSchemaNode,
  renderer: DynamicRenderer,
}) => {
  const { api, drawers, elements = [], url, translations } = uiSchemaNode;

  return (
    <ViewProvider
      apiRegistry={api}
      drawersRegistry={drawers}
      basePath={url}
      translations={translations}
    >
      <ViewContent elements={elements} renderer={DynamicRenderer} />
      <DrawerOutlet renderer={DynamicRenderer} />
    </ViewProvider>
  );
};
```

**Key**:

- `DrawerOutlet` is SIBLING to content, not nested inside
- ViewProvider wraps both

---

### 3. DrawerOutlet (`/frontend/app/lib/ui/layouts/view.tsx`)

```tsx
export const DrawerOutlet: FC<{
  renderer: RecursiveRendererProps["renderer"];
}> = ({ renderer: DynamicRenderer }) => {
  const { drawerState, closeDrawer, getCurrentDrawerConfig } = useViewContext();
  const drawerConfig = getCurrentDrawerConfig();

  return (
    <AppSheet
      open={drawerState.isOpen}
      onClose={closeDrawer}
      title={drawerConfig?.title || ""}
    >
      {drawerConfig?.elements?.map((element, index) => (
        <DynamicRenderer key={index} uiSchema={element} />
      ))}
    </AppSheet>
  );
};
```

**Key**:

- Gets drawer state from context via `useViewContext()`
- NO data prop passed to DynamicRenderer
- Drawer item is accessed via `drawerState.item` in context

---

### 4. ViewContext (`/frontend/app/lib/ui/contexts/view-context.tsx`)

```tsx
interface DrawerState {
  isOpen: boolean;
  drawerName: string | null;
  item: Item | null; // <-- Row data lives here
}

interface ViewContextValue {
  drawerState: DrawerState;
  openDrawer: (drawerName: string, item?: Item | null) => void;
  closeDrawer: () => void;
  getCurrentDrawerConfig: () => DrawerConfig | null;
  // ...
}

const openDrawer = useCallback((drawerName: string, item?: Item | null) => {
  setDrawerState({
    isOpen: true,
    drawerName,
    item: item ?? null,
  });
}, []);
```

**Key**: Row data stored in `drawerState.item`, not passed as props.

---

### 5. Show Component (`/frontend/app/lib/ui/layouts/show.tsx`)

```tsx
export const ShowRenderer: FC<RecursiveRendererProps> = ({
  uiSchemaNode,
  renderer: DynamicRenderer,
}) => {
  const { drawerState } = useViewContext();
  const item = drawerState.item; // <-- Gets data from context

  const { elements = [] } = uiSchemaNode;

  return (
    <ShowContext.Provider value={{ data: item?.data || {} }}>
      {elements.map((element, index) => (
        <DynamicRenderer key={index} uiSchema={element} />
      ))}
    </ShowContext.Provider>
  );
};
```

**Key**:

- Gets `item` from `useViewContext().drawerState.item`
- Provides `item.data` via ShowContext for display components
- Renders children using passed `renderer`

---

### 6. Form Component (`/frontend/app/lib/ui/layouts/form.tsx`)

```tsx
export const FormRenderer: FC<RecursiveRendererProps> = ({
  uiSchemaNode,
  renderer: DynamicRenderer,
}) => {
  const { drawerState } = useViewContext();
  const item = drawerState.item; // <-- Gets data from context

  const initialValues = item?.data || {};

  return (
    <Formik initialValues={initialValues} onSubmit={handleSubmit}>
      {elements.map((element, index) => (
        <DynamicRenderer key={index} uiSchema={element} />
      ))}
    </Formik>
  );
};
```

**Key**: Gets initial values from `drawerState.item.data`

---

### 7. Table Row Click (`/frontend/app/lib/ui/layouts/table.tsx`)

```tsx
const handleRowClick = useMemo(() => {
  if (rowClick?.opens) {
    return (row: Item) => {
      viewContext.openDrawer(rowClick.opens!, row); // <-- Pass raw row
    };
  }
  return undefined;
}, [rowClick, viewContext]);
```

**Key**:

- Passes raw `row` which is `{ id, data: {...} }`
- Does NOT flatten data

---

## Files to Modify

### 1. `packs/ui/app/frontend/lib/ui-renderer/renderer.tsx`

Current:

```tsx
export function DynamicRenderer({ schema, data = {}, active }) {
  // ... passes data, elements, renders children
}
```

Change to:

```tsx
export function DynamicRenderer({ schema }) {
  const Component = adapterRegistry[schema.type];
  if (!Component) return null;

  return <Component uiSchemaNode={schema} renderer={DynamicRenderer} />;
}
```

### 2. `packs/ui/app/frontend/adapters/custom/view/view.tsx`

- Extract `DrawerOutlet` as separate component
- DrawerOutlet uses `useViewContext()` to get drawer state
- No `data` prop to DynamicRenderer

### 3. `packs/ui/app/frontend/adapters/layouts/show.tsx`

- Receive `uiSchemaNode` and `renderer`
- Get data from `useViewContext().drawerState.item`
- Render children using `renderer`

### 4. `packs/ui/app/frontend/adapters/layouts/group.tsx`

- Receive `uiSchemaNode` and `renderer`
- Render children using `renderer(element)`

### 5. `packs/ui/app/frontend/adapters/custom/form/form.tsx`

- Get initial values from `useViewContext().drawerState.item`
- Render children using `renderer`

### 6. All other layout components

Same pattern: receive `uiSchemaNode` + `renderer`, render own children.

---

## Component Props Pattern

Before:

```tsx
function MyComponent({ data, children, ...props }) {
  return <div>{children}</div>;
}
```

After:

```tsx
function MyComponent({ uiSchemaNode, renderer: DynamicRenderer }) {
  const { elements = [] } = uiSchemaNode;

  return (
    <div>
      {elements.map((el, i) => (
        <DynamicRenderer key={i} schema={el} />
      ))}
    </div>
  );
}
```

---

## Data Flow

```
Table row click
    |
    v
viewContext.openDrawer("view_drawer", row)
    |
    v
drawerState = { isOpen: true, drawerName: "view_drawer", item: row }
    |
    v
DrawerOutlet re-renders (reads from context)
    |
    v
DynamicRenderer renders drawer elements (NO data prop)
    |
    v
Show/Form uses useViewContext().drawerState.item
```

---

## Item Structure

Keep as-is from API:

```typescript
interface Item {
  id: number;
  data: Record<string, unknown>;
}
```

Table does NOT flatten. Show/Form access `item.data` for fields.

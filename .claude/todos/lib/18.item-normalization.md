# Item Normalization: Flatten `data` to Top-Level Attributes

## Problem Statement

Currently, Items store domain data in a `data` JSONB column. The API returns:

```json
{ "id": 1, "data": { "first_name": "John", "last_name": "Doe" } }
```

This forces the frontend to handle nested `data` extraction everywhere. We want Items to **look like ActiveRecord models**:

```json
{ "id": 1, "first_name": "John", "last_name": "Doe" }
```

## Solution Overview

1. **Serializer**: Flatten `item.data` fields to top-level in API responses
2. **Controller**: Wrap incoming flat params back into `data` for storage
3. **Frontend**: Remove `data` nesting/extraction logic

---

## Phase 1: Backend - Per-Service Serializers

### 1.1 Create Base Flattening Serializer

**File**: `packs/core/app/lib/core/serializers/flat_item_serializer.rb`

```ruby
# frozen_string_literal: true

module Core
  module Serializers
    class FlatItemSerializer
      include Alba::Resource

      # Base attributes always present
      attributes :id, :workspace_id, :schema_slug, :created_by_id, :updated_by_id

      attribute :created_at do |item|
        item.created_at&.iso8601
      end

      attribute :updated_at do |item|
        item.updated_at&.iso8601
      end

      # Subclasses define which schema to use for flattening
      class << self
        attr_accessor :schema_class

        def schema(klass)
          @schema_class = klass
        end
      end

      # Dynamically flatten data fields to top-level
      def self.inherited(subclass)
        super
        subclass.instance_eval do
          attribute :_flattened_data do |item|
            # This gets merged at serialization time
            item.data || {}
          end
        end
      end

      # Override Alba's to_h to merge flattened data
      def to_h
        result = super
        flattened = result.delete(:_flattened_data) || {}

        # Add relationship attributes
        relationships = load_relationships(@object)
        relationships.each do |rel_name, rel_data|
          flattened["#{rel_name}_attributes"] = rel_data
        end

        result.merge(flattened.transform_keys(&:to_sym))
      end

      private

        def load_relationships(item)
          return {} unless item.schema_slug

          schema_class = Core::Schema::Registry.find(item.schema_slug)
          return {} unless schema_class&.respond_to?(:relationships)

          relationships = schema_class.relationships || []
          return {} if relationships.empty?

          result = {}

          relationships.each do |rel|
            rel_name = rel[:name].to_s
            cardinality = rel[:cardinality]

            rel_records = ItemRelationship
              .where(source_item_id: item.id, relationship_type: rel_name)
              .includes(:target_item)

            if cardinality == :one
              target = rel_records.first&.target_item
              # Flatten target's data too
              result[rel_name] = target ? { "id" => target.id }.merge(target.data) : nil
            else
              result[rel_name] = rel_records.filter_map do |r|
                next unless r.target_item
                { "id" => r.target_item.id }.merge(r.target_item.data)
              end
            end
          end

          result
        end
    end
  end
end
```

### 1.2 Create ContactsService Serializer

**File**: `packs/contacts_service/app/lib/contacts_service/contact_serializer.rb`

```ruby
# frozen_string_literal: true

module ContactsService
  class ContactSerializer < Core::Serializers::FlatItemSerializer
    schema ContactSchema
  end
end
```

### 1.3 Create RibCheckService Serializer

**File**: `packs/rib_check_service/app/lib/rib_check_service/rib_request_serializer.rb`

```ruby
# frozen_string_literal: true

module RibCheckService
  class RibRequestSerializer < Core::Serializers::FlatItemSerializer
    schema RibRequestSchema
  end
end
```

### 1.4 Update Tools to Use Service-Specific Serializers

**Files to update**:

| File                                                                | Change                                             |
| ------------------------------------------------------------------- | -------------------------------------------------- |
| `packs/contacts_service/app/lib/contacts_service/tools/show.rb`     | `ContactSerializer` instead of `ItemSerializer`    |
| `packs/contacts_service/app/lib/contacts_service/tools/create.rb`   | `ContactSerializer` instead of `ItemSerializer`    |
| `packs/contacts_service/app/lib/contacts_service/tools/update.rb`   | `ContactSerializer` instead of `ItemSerializer`    |
| `packs/contacts_service/app/lib/contacts_service/tools/index.rb`    | `ContactSerializer` instead of `ItemSerializer`    |
| `packs/rib_check_service/app/lib/rib_check_service/tools/show.rb`   | `RibRequestSerializer` instead of `ItemSerializer` |
| `packs/rib_check_service/app/lib/rib_check_service/tools/create.rb` | `RibRequestSerializer` instead of `ItemSerializer` |
| `packs/rib_check_service/app/lib/rib_check_service/tools/update.rb` | `RibRequestSerializer` instead of `ItemSerializer` |
| `packs/rib_check_service/app/lib/rib_check_service/tools/index.rb`  | `RibRequestSerializer` instead of `ItemSerializer` |

**Example change** (`contacts_service/tools/show.rb`):

```ruby
# Before
{ data: Core::Serializers::ItemSerializer.new(item).to_h }

# After
{ data: ContactSerializer.new(item).to_h }
```

---

## Phase 2: Backend - Controller Param Wrapping

### 2.1 Update Tool Params DSL

The tools currently expect `object :data, of: ContactSchema`. We need to change this to accept flat params.

**Option A**: Change tools to accept flat params directly
**Option B**: Wrap params in controller before passing to tools (transparent to tools)

**Recommended: Option B** - Minimal changes to existing tools.

### 2.2 Update RailsParameters to Build Flat Permit Structure

**File**: `packs/core/app/lib/core/tools/rails_parameters.rb`

```ruby
# Current: [:id, data: [:first_name, :last_name, ...]]
# New:     [:id, :first_name, :last_name, ...]

def self.permit_structure(tool_class)
  schema = tool_class.new.params_schema
  return [] unless schema && schema["properties"]

  schema_class = tool_class.respond_to?(:schema_class) ? tool_class.schema_class : nil

  # For tools with schema, flatten the data object
  if schema_class
    build_flat_permit_structure(schema["properties"], schema_class)
  else
    build_permit_structure(schema["properties"], schema_class)
  end
end

private_class_method def self.build_flat_permit_structure(properties, schema_class)
  result = []

  properties.each do |key, prop|
    key_sym = key.to_sym

    if key == "data" && prop["type"] == "object" && prop["properties"]
      # Flatten data fields to top-level
      prop["properties"].each_key do |data_key|
        result << data_key.to_sym
      end
      # Add relationship attributes
      if schema_class&.respond_to?(:relationships)
        schema_class.relationships.each do |rel|
          attr_key = :"#{rel[:name]}_attributes"
          target_schema = Schema::Registry.find(rel[:target_schema])
          json_schema = target_schema&.new&.to_json_schema
          target_fields = json_schema&.dig(:schema, :properties)&.keys&.map(&:to_sym) || []
          result << { attr_key => [:id, :_destroy] + target_fields }
        end
      end
    elsif prop["type"] != "object"
      result << key_sym
    end
  end

  result
end
```

### 2.3 Update ResourcesController to Wrap Flat Params

**File**: `packs/core/app/controllers/core/v1/resources_controller.rb`

```ruby
def tool_params
  permitted = Tools::RailsParameters.permit_structure(@tool_class)
  flat_params = params.permit(:namespace, :feature, :action_name, *permitted).to_h
    .except("namespace", "feature", "action_name")
    .deep_symbolize_keys

  # If tool expects :data param, wrap schema fields into it
  if @tool_class.respond_to?(:schema_class) && @tool_class.schema_class
    wrap_into_data(flat_params, @tool_class.schema_class)
  else
    flat_params
  end
end

def wrap_into_data(flat_params, schema_class)
  schema_fields = schema_class.new.to_json_schema.dig(:schema, :properties)&.keys || []
  relationship_keys = schema_class.relationships.map { |r| "#{r[:name]}_attributes" }
  all_data_keys = schema_fields + relationship_keys

  data = {}
  other = {}

  flat_params.each do |key, value|
    if all_data_keys.include?(key.to_s)
      data[key] = value
    else
      other[key] = value
    end
  end

  other.merge(data: data)
end
```

---

## Phase 3: Frontend Changes

### 3.1 Update Form Adapter

**File**: `packs/ui/app/frontend/adapters/custom/form/form.tsx`

**Changes**:

```typescript
// Line 28-31: Remove data extraction - drawerData is now flat
// BEFORE:
const recordData = drawerData?.data ?? drawerData;
const initialData = use_record && recordData ? recordData : defaultValues;

// AFTER:
const initialData = use_record && drawerData ? drawerData : defaultValues;


// Line 69: Remove data wrapper - send flat values
// BEFORE:
body: { data: values },

// AFTER:
body: values,


// Line 104-108: Remove data extraction in resetForm
// BEFORE:
const formValues = drawerData?.data ?? drawerData;
resetForm({ values: formValues });

// AFTER:
resetForm({ values: drawerData });
```

### 3.2 Update Show Adapter

**File**: `packs/ui/app/frontend/adapters/layouts/show.tsx`

**Changes**:

```typescript
// Line 37-42: Remove data extraction - drawerData is now flat
// BEFORE:
const contextData = drawerData?.data ?? drawerData;
const showData = contextData ?? data ?? record ?? {};

// AFTER:
const showData = drawerData ?? data ?? record ?? {};
```

### 3.3 Update Table Adapter

**File**: `packs/ui/app/frontend/adapters/custom/table/table.tsx`

**Changes**:

```typescript
// Line 124-125: Simplify accessorFn - data is now flat
// BEFORE:
accessorFn: (row: DataTableRow) =>
  (row.data as Record<string, unknown>)?.[col.name] ?? row[col.name],

// AFTER:
accessorFn: (row: DataTableRow) => row[col.name],
```

### 3.4 Update Relationship Picker Create Drawer

**File**: `packs/ui/app/frontend/adapters/custom/relationship-picker/create-drawer.tsx`

**Changes**:

```typescript
// Line 55-58: Remove data wrapper in POST
// BEFORE:
data: { data: formValues },

// AFTER:
data: formValues,


// Line 66-68: Flatten response handling
// BEFORE:
const item = response.data;
onSuccess({ id: item.id, ...item.data });

// AFTER:
onSuccess(response.data);
```

### 3.5 Update View Adapter

**File**: `packs/ui/app/frontend/adapters/custom/view/view.tsx`

**Changes**:

```typescript
// Line 140: Send body directly (already passed from form)
// No change needed - body is passed from form, which now sends flat values
```

---

## Phase 4: Test Updates

### 4.1 Backend Spec Updates

**Files to update**:

| File                                                         | Change                                           |
| ------------------------------------------------------------ | ------------------------------------------------ |
| `packs/contacts_service/spec/requests/contacts_spec.rb`      | Update response expectations - no `data` wrapper |
| `packs/rib_check_service/spec/requests/rib_requests_spec.rb` | Update response expectations                     |
| `packs/core/spec/lib/core/serializers/*`                     | Add specs for FlatItemSerializer                 |

**Example change**:

```ruby
# Before
expect(body["data"]["data"]["first_name"]).to eq("John")

# After
expect(body["data"]["first_name"]).to eq("John")
```

### 4.2 Frontend Test Updates

**Files to update**:

| File                                                                                              | Changes Needed                                                |
| ------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| `packs/contacts_service/app/frontend/__tests__/integrations/phase-11-api.test.tsx`                | Line 204-207, 242-245: Remove `data:` wrapper in expectations |
| `packs/contacts_service/app/frontend/__tests__/integrations/phase-12-fullpage.test.tsx`           | Verify mock data format (already flat)                        |
| `packs/contacts_service/app/frontend/__tests__/integrations/phase-13-relationshippicker.test.tsx` | Line 826-831: Update mock response handling                   |
| `packs/rib_check_service/app/frontend/__tests__/integrations/rib-requests.test.tsx`               | Update expectations                                           |

**Example change** (`phase-11-api.test.tsx`):

```typescript
// Before
expect(mockFetch).toHaveBeenCalledWith("/api/contacts", {
  method: "POST",
  data: { data: { name: "Test Contact" } },
});

// After
expect(mockFetch).toHaveBeenCalledWith("/api/contacts", {
  method: "POST",
  data: { name: "Test Contact" },
});
```

---

## Phase 5: Regenerate Mocks

After all changes, regenerate frontend mocks:

```bash
bundle exec rake core:export_mocks
```

---

## Execution Order

1. **Phase 1.1-1.3**: Create FlatItemSerializer and service serializers
2. **Phase 1.4**: Update tools to use new serializers
3. **Phase 2**: Update controller param handling
4. **Run backend specs** - fix failures
5. **Phase 3**: Update frontend adapters
6. **Phase 4**: Update tests
7. **Phase 5**: Regenerate mocks
8. **Run full test suite**

---

## Files Changed Summary

### Backend (Ruby) - 15 files

| File                                                                          | Action |
| ----------------------------------------------------------------------------- | ------ |
| `packs/core/app/lib/core/serializers/flat_item_serializer.rb`                 | CREATE |
| `packs/contacts_service/app/lib/contacts_service/contact_serializer.rb`       | CREATE |
| `packs/rib_check_service/app/lib/rib_check_service/rib_request_serializer.rb` | CREATE |
| `packs/contacts_service/app/lib/contacts_service/tools/show.rb`               | EDIT   |
| `packs/contacts_service/app/lib/contacts_service/tools/create.rb`             | EDIT   |
| `packs/contacts_service/app/lib/contacts_service/tools/update.rb`             | EDIT   |
| `packs/contacts_service/app/lib/contacts_service/tools/index.rb`              | EDIT   |
| `packs/rib_check_service/app/lib/rib_check_service/tools/show.rb`             | EDIT   |
| `packs/rib_check_service/app/lib/rib_check_service/tools/create.rb`           | EDIT   |
| `packs/rib_check_service/app/lib/rib_check_service/tools/update.rb`           | EDIT   |
| `packs/rib_check_service/app/lib/rib_check_service/tools/index.rb`            | EDIT   |
| `packs/core/app/lib/core/tools/rails_parameters.rb`                           | EDIT   |
| `packs/core/app/controllers/core/v1/resources_controller.rb`                  | EDIT   |
| `packs/contacts_service/spec/requests/contacts_spec.rb`                       | EDIT   |
| `packs/rib_check_service/spec/requests/rib_requests_spec.rb`                  | EDIT   |

### Frontend (TypeScript) - 8 files

| File                                                                                              | Action                |
| ------------------------------------------------------------------------------------------------- | --------------------- |
| `packs/ui/app/frontend/adapters/custom/form/form.tsx`                                             | EDIT (3 changes)      |
| `packs/ui/app/frontend/adapters/layouts/show.tsx`                                                 | EDIT (1 change)       |
| `packs/ui/app/frontend/adapters/custom/table/table.tsx`                                           | EDIT (1 change)       |
| `packs/ui/app/frontend/adapters/custom/relationship-picker/create-drawer.tsx`                     | EDIT (2 changes)      |
| `packs/contacts_service/app/frontend/__tests__/integrations/phase-11-api.test.tsx`                | EDIT                  |
| `packs/contacts_service/app/frontend/__tests__/integrations/phase-13-relationshippicker.test.tsx` | EDIT                  |
| `packs/rib_check_service/app/frontend/__tests__/integrations/rib-requests.test.tsx`               | EDIT                  |
| `packs/contacts_service/app/frontend/__tests__/mocks/data.json`                                   | VERIFY (already flat) |

---

## Risk Assessment

| Risk                                | Mitigation                                            |
| ----------------------------------- | ----------------------------------------------------- |
| Breaking existing API consumers     | This is internal API - no external consumers          |
| Missing edge cases in serialization | Existing ItemSerializer tests provide coverage        |
| Relationship data format change     | Relationships already flatten target.data - no change |
| Form submission failures            | Comprehensive test coverage in phase-11, phase-13     |

---

## Rollback Plan

If issues arise:

1. Revert FlatItemSerializer changes
2. Keep ItemSerializer as-is
3. Frontend changes are isolated to 4 adapter files - easy revert

---

## Success Criteria

1. All backend specs pass (511 examples)
2. All frontend tests pass (637 examples)
3. API responses have flat structure: `{ id, first_name, last_name, ... }`
4. Forms submit flat data: `{ first_name, last_name, ... }`
5. No `drawerData?.data` extraction in frontend code

# 15. Default CRUD UI - Formik Migration

## Prerequisites

**Requires: [14.ui-registries.md](./14.ui-registries.md)** - Registry refactor with FormikAdapter/DisplayAdapter

---

## Summary

Custom FormContext is broken. Replace with Formik.

---

## Phase 1: Install Formik

```bash
cd packs/ui/app/frontend && npm install formik
```

---

## Phase 2: Create DynamicForm Wrapper

```typescript
// packs/ui/app/frontend/lib/ui-renderer/dynamic-form.tsx

import { Formik, Form, type FormikValues } from "formik";
import { DynamicRenderer } from "./renderer";
import type { UISchema } from "./types";

interface DynamicFormProps {
  uiSchema: UISchema;
  initialValues: FormikValues;
  onSubmit: (values: FormikValues) => void;
  className?: string;
}

export function DynamicForm({
  uiSchema,
  initialValues,
  onSubmit,
  className,
}: DynamicFormProps) {
  const elements = uiSchema.type === "FORM"
    ? uiSchema.elements || []
    : [uiSchema];

  return (
    <Formik
      initialValues={initialValues}
      enableReinitialize
      onSubmit={onSubmit}
    >
      <Form className={className}>
        {elements.map((element, index) => (
          <DynamicRenderer key={index} schema={element} data={{}} />
        ))}
      </Form>
    </Formik>
  );
}
```

---

## Phase 3: Update Form Adapter

```typescript
// packs/ui/app/frontend/adapters/custom/form/form.tsx

import { Formik, Form as FormikForm } from "formik";
import { cn } from "@ui/lib/utils";
import type { FormProps } from "@ui/lib/ui-renderer/registry";
import { useViewConfig, useDrawer } from "../view";

export function Form({
  action,
  use_record,
  notification,
  onSubmit,
  defaultValues = {},
  className,
  children,
}: FormProps) {
  const { executeApi } = useViewConfig();
  const { drawerData } = useDrawer();

  const initialData = use_record && drawerData ? drawerData : defaultValues;

  const handleSubmit = async (values: Record<string, unknown>) => {
    try {
      await executeApi({
        action: action || "save",
        url_parameters: use_record && drawerData ? drawerData : values,
        body: { data: values },
        notification,
      });
      if (onSubmit) await onSubmit(values);
    } catch (error) {
      console.error("Form submission error:", error);
    }
  };

  return (
    <Formik
      initialValues={initialData}
      enableReinitialize
      onSubmit={handleSubmit}
    >
      <FormikForm
        data-ui="form"
        data-testid="form-renderer"
        className={cn("space-y-6", className)}
      >
        {children}
      </FormikForm>
    </Formik>
  );
}

// Re-export Formik hooks
export { useFormikContext as useFormContext, useField } from "formik";
```

---

## Phase 4: Update Submit Adapter

```typescript
// packs/ui/app/frontend/adapters/submit.tsx

import { Button } from "@ui/components/button";
import { Loader2 } from "lucide-react";
import { useTranslate } from "@ui/lib/ui-renderer/provider";
import { useFormikContext } from "formik";
import type { SubmitProps } from "@ui/lib/ui-renderer/registry";

export function Submit({
  label = "Submit",
  loadingLabel = "Submitting...",
  className,
}: SubmitProps) {
  const t = useTranslate();
  const { isSubmitting } = useFormikContext();

  return (
    <Button
      data-ui="submit"
      type="submit"
      disabled={isSubmitting}
      className={className}
    >
      {isSubmitting ? (
        <>
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          {t(loadingLabel)}
        </>
      ) : (
        t(label)
      )}
    </Button>
  );
}
```

---

## Phase 5: Update RelationshipPicker

```typescript
// packs/ui/app/frontend/adapters/custom/relationship-picker/relationship-picker.tsx

import { useField } from "formik";

export function RelationshipPicker({ name, ... }: RelationshipPickerProps) {
  const [field, , helpers] = useField(name);

  // field.value for current value
  // helpers.setValue() for updates
}
```

---

## Phase 6: Update RelationshipCreateDrawer

```typescript
// packs/ui/app/frontend/adapters/custom/relationship-picker/create-drawer.tsx

import { type FC } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from "@ui/components/sheet";
import { useServices, useTranslate } from "@ui/lib/ui-renderer/provider";
import { DynamicForm } from "@ui/lib/ui-renderer/dynamic-form";
import type { UISchema } from "@ui/lib/ui-renderer/types";

interface RelationshipCreateDrawerProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  name: string;
  template: UISchema[];
  basePath: string;
  onSuccess: (item: { id: number; [key: string]: unknown }) => void;
  _ns?: string;
}

export const RelationshipCreateDrawer: FC<RelationshipCreateDrawerProps> = ({
  open,
  onOpenChange,
  name,
  template,
  basePath,
  onSuccess,
  _ns = "common",
}) => {
  const t = useTranslate();
  const services = useServices();
  const queryClient = useQueryClient();

  const createMutation = useMutation({
    mutationFn: async (values: Record<string, unknown>) => {
      const response = await services.fetch(basePath, {
        method: "POST",
        body: JSON.stringify({ data: values }),
      });
      return response;
    },
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: ["relationship-picker", basePath] });
      const item = response.data;
      onSuccess({ id: item.id, ...item.data });
      onOpenChange(false);
    },
  });

  const initialValues = template.reduce((acc, field) => {
    if (field.name) acc[field.name] = field.defaultValue ?? "";
    return acc;
  }, {} as Record<string, unknown>);

  const uiSchema: UISchema = {
    type: "FORM",
    elements: [
      ...template,
      { type: "SUBMIT", label: "add", loadingLabel: "saving" },
    ],
  };

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent
        side="right"
        className="w-[450px] sm:max-w-[450px]"
        data-testid={`relationship-create-drawer-${name}`}
      >
        <SheetHeader>
          <SheetTitle>{t("create_new")}</SheetTitle>
          <SheetDescription className="sr-only">
            {t("create_new_description")}
          </SheetDescription>
        </SheetHeader>
        <div className="flex-1 overflow-y-auto p-4">
          <DynamicForm
            uiSchema={uiSchema}
            initialValues={initialValues}
            onSubmit={(values) => createMutation.mutate(values)}
            className="space-y-4"
          />
        </div>
      </SheetContent>
    </Sheet>
  );
};
```

---

## Phase 7: Fix Search Param Bug

```typescript
// packs/ui/app/frontend/adapters/custom/relationship-picker/picker-drawer.tsx line ~106

// Change:
params.q = searchQuery;

// To:
params.search = searchQuery;
```

---

## Phase 8: Delete Custom FormContext

Remove from `adapters/custom/form/form.tsx`:
- `FormContext` (createContext)
- Custom `useFormContext`
- Custom `useField`
- All `useState` for form state
- All manual state management

---

## Files Summary

| File | Action |
|------|--------|
| `package.json` | Add `formik` |
| `lib/ui-renderer/dynamic-form.tsx` | CREATE |
| `adapters/custom/form/form.tsx` | REWRITE - use Formik, delete custom context |
| `adapters/submit.tsx` | UPDATE - use useFormikContext |
| `adapters/custom/relationship-picker/relationship-picker.tsx` | UPDATE - use Formik useField |
| `adapters/custom/relationship-picker/create-drawer.tsx` | UPDATE - use DynamicForm |
| `adapters/custom/relationship-picker/picker-drawer.tsx` | FIX - `q` â†’ `search` |

---

## Success Criteria

1. Layer 3 form submits with correct payload
2. Only ONE API call per submit (no double submit)
3. All existing tests pass
4. Search works in picker drawer
